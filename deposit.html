<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deposit</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Твои стили -->
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

    <!-- Header -->
    <div class="header-nav">
        <button class="back-btn" onclick="window.history.back()">
            <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <div class="header-title">Deposit</div>
    </div>

    <!-- Content -->
    <div style="padding: 20px 16px;">
        
        <!-- Input Wrapper -->
        <div class="input-wrapper">
            <input type="number" id="amountInput" placeholder="Amount" oninput="updateButton()">
            <div class="input-suffix">
                <span>BLYX</span>
                <img src="Sprites/Blyx.png" class="star-icon-small" alt="blyx">
            </div>
        </div>

        <!-- Info Text -->
        <div style="display: flex; justify-content: space-between; padding: 0 4px; margin-top: 8px;">
            <p class="text-sec">Rate: 1 BLYX = 1 Star</p>
            <p class="text-sec" style="color: #FF3B30;">Min: 50 BLYX</p>
        </div>
    </div>

    <!-- Bottom Fixed Panel -->
    <div class="bottom-cost-panel">
        <div class="cost-label">Total Cost</div>
        <button class="btn-white-large" id="payBtn" onclick="handleDeposit()">
            Pay <span id="btnAmount">0</span>
            <img src="Sprites/star.png" class="star-icon-small" alt="star">
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');

        // ==========================================
        // ВСТАВЬ СЮДА ССЫЛКУ НА ТВОЙ VERCEL СЕРВЕР (без / в конце)
        const BACKEND_URL = "https://sdadw3easdwewfrd.vercel.app"; 
        // ==========================================

        const userId = tg.initDataUnsafe?.user?.id;

        function updateButton() {
            const val = document.getElementById('amountInput').value;
            document.getElementById('btnAmount').innerText = val ? val : '0';
        }

        async function handleDeposit() {
            const amount = parseInt(document.getElementById('amountInput').value);
            
            // ПРОВЕРКА НА МИНИМУМ
            if (!amount || amount < 50) {
                tg.showPopup({ 
                    title: 'Too low amount', 
                    message: 'The minimum deposit amount is 50 BLYX.' 
                });
                return;
            }

            const btn = document.getElementById('payBtn');
            const originalText = document.getElementById('btnAmount').innerText;
            
            btn.disabled = true;
            btn.style.opacity = "0.7";

            try {
                const response = await fetch(`${BACKEND_URL}/create-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: userId,
                        amount: amount 
                    })
                });

                const data = await response.json();

                if (!data.ok) {
                    throw new Error(data.error || 'Failed to create invoice');
                }

                tg.openInvoice(data.link, (status) => {
                    if (status === 'paid') {
                        tg.showPopup({ 
                            title: 'Success!', 
                            message: `Successfully deposited ${amount} BLYX.` 
                        }, () => {
                            window.history.back();
                        });
                    } else {
                        btn.disabled = false;
                        btn.style.opacity = "1";
                    }
                });

            } catch (error) {
                console.error(error);
                tg.showAlert("Error: " + error.message);
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        }
    </script>
</body>
</html>
