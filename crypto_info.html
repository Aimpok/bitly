<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Info</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Chart.js –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- Header -->
    <div class="launch-header">
        <div class="top-nav">
            <button class="back-btn" onclick="window.history.back()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            </button>
            <div style="font-weight: 700;">Details</div>
            <div style="width: 24px;"></div>
        </div>

        <!-- Token Icon -->
        <img id="tokenIcon" src="" class="token-avatar-big" style="display:none;">
        <div id="tokenLetter" class="token-avatar-big" style="display:none; background:#333; display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:700;">?</div>
        
        <div class="token-name-header" id="tokenName">LOADING...</div>

        <!-- Holders | Txs -->
        <div class="stats-split-row">
            <div class="stat-box">
                <svg class="icon" style="width:16px;height:16px;" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span class="stat-val" id="holdersCount">0</span>
            </div>
            <div class="divider-v"></div>
            <div class="stat-box">
                <svg class="icon" style="width:16px;height:16px;" viewBox="0 0 24 24"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                <span class="stat-val" id="txCount">0</span>
            </div>
        </div>

        <!-- Market Cap Big -->
        <div class="market-cap-row">
            <span class="mc-val" id="marketCapVal">0</span>
            <img src="Sprites/Blyx.png" class="mc-icon">
        </div>

        <!-- Bonding Curve -->
        <div class="progress-container" id="bondingContainer">
            <div class="p-bar-bg">
                <div class="p-bar-fill" id="bondingBar" style="width: 0%;"></div>
            </div>
            <div class="p-labels">
                <span id="bondingText">0% collected</span>
                <span style="color: #888;">Trading Unlock at 100%</span>
            </div>
        </div>
        <div class="progress-container" id="tradingLive" style="display: none; text-align: center;">
            <span style="color: #CCFF00; font-weight: 700; font-size: 14px;">‚ö° TRADING IS LIVE ON DEX</span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-scroll">
        <div class="tab-link active" onclick="switchTab('chart', this)">Chart</div>
        <div class="tab-link" onclick="switchTab('tx', this)">Transactions</div>
        <div class="tab-link" onclick="switchTab('socials', this)">Socials</div>
    </div>

    <!-- Content -->
    <div class="content-section">
        
        <!-- TAB: CHART -->
        <div id="tab-chart">
            <div class="chart-controls">
                <div class="time-btn active">1h</div>
                <div class="time-btn">1D</div>
            </div>
            <div class="chart-area">
                <canvas id="priceChart"></canvas>
            </div>
            
            <div class="trans-summary">
                <div class="ts-item">
                    <div class="ts-label">Your Balance</div>
                    <div class="ts-val" id="myTokenBalance">0</div>
                </div>
                <div class="ts-item" style="text-align: right;">
                    <div class="ts-label">Value (BLYX)</div>
                    <div class="ts-val" style="color: var(--accent-green);" id="myTokenValue">‚âà 0</div>
                </div>
            </div>
            <div style="height: 120px;"></div>
        </div>

        <!-- TAB: TX -->
        <div id="tab-tx" class="hidden">
            <div class="trans-list" id="txList">
                <div style="text-align:center; padding:20px; color:#555;">Loading...</div>
            </div>
            <div style="height: 120px;"></div>
        </div>

        <!-- TAB: SOCIALS -->
        <div id="tab-socials" class="hidden">
            <div class="social-list">
                 <div class="social-card">
                    <div class="sc-left">
                        <div class="sc-title">Description</div>
                        <div class="sc-sub" id="tokenDesc">No description.</div>
                    </div>
                </div>
            </div>
            <div style="height: 120px;"></div>
        </div>
    </div>

    <!-- Actions -->
    <div class="fixed-action-container">
        <div style="display: flex; gap: 10px;">
            <button class="btn-buy-floating" id="sellBtn" style="background: #1c1c1c; color: white; border: 1px solid #333; display:none;" onclick="openTrade('sell')">
                Sell
            </button>
            <button class="btn-buy-floating" style="background: white; color: black;" onclick="openTrade('buy')">
                Buy
            </button>
        </div>
    </div>

    <!-- Trade Overlay -->
    <div id="tradeOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; flex-direction:column; justify-content:center; padding: 20px;">
        <h2 id="tradeTitle" style="text-align:center; margin-bottom:20px; font-size: 24px;">Buy</h2>
        
        <div class="input-wrapper">
            <input type="number" id="tradeInput" placeholder="Amount" oninput="calcTrade()">
            <div class="input-suffix" id="tradeSuffix">BLYX</div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:14px; color:#888;">
            <span>Balance: <span id="tradeBalance" style="color:white;">0</span></span>
            <span id="receiveLabel">You get: <span id="tradeTotal" style="color:white;">0</span> TOKENS</span>
        </div>

        <button class="btn-white-large" onclick="executeTrade()">Confirm</button>
        <button class="btn-text" style="margin-top:10px; width:100%; text-align:center; color:#555;" onclick="closeTrade()">Cancel</button>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="location.href='index.html'">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </div>
        <div class="nav-item" onclick="location.href='markets.html'">
            <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
        </div>
        <div class="nav-trade-circle" onclick="location.href='crypto_info.html'">
             <svg class="icon" style="color:black;" viewBox="0 0 24 24"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
        </div>
        <div class="nav-item" onclick="location.href='transfer.html'">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        </div>
        <div class="nav-item" onclick="location.href='wallet.html'">
            <svg class="icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
        </div>
    </div>

    <script type="module">
        import { initUser, subscribeToUser } from './user-service.js';
        import { db } from './firebase-config.js';
        import { doc, onSnapshot, updateDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');

        const urlParams = new URLSearchParams(window.location.search);
        const tokenId = urlParams.get('id');
        
        let currentTokenData = null;
        let currentUserData = null;
        let tradeType = 'buy';
        let priceChart = null;

        const TOTAL_SUPPLY = 1000000000; // 1 –ú–∏–ª–ª–∏–∞—Ä–¥ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ

        // TABS
        window.switchTab = function(tabName, el) {
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            ['chart', 'tx', 'socials'].forEach(id => document.getElementById('tab-' + id).classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
        }

        async function initPage() {
            if(!tokenId) return;
            await initUser();

            // 1. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ–∫–µ–Ω
            onSnapshot(doc(db, "tokens", tokenId), (docSnap) => {
                if (docSnap.exists()) {
                    currentTokenData = docSnap.data();
                    renderTokenInfo();
                    updateChart(currentTokenData.price);
                }
            });

            // 2. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —é–∑–µ—Ä–∞
            subscribeToUser((user) => {
                currentUserData = user;
                renderUserPos();
                renderHistory();
            });
        }

        function renderTokenInfo() {
            // –ò–º—è
            document.getElementById('tokenName').innerText = currentTokenData.name;
            document.getElementById('tokenDesc').innerText = currentTokenData.description || "No description.";
            
            // Stats: Holders | Transactions
            // (–ü–æ–∫–∞ –±–µ—Ä–µ–º –∏–∑ –±–∞–∑—ã, –µ—Å–ª–∏ –ø–æ–ª–µ–π –Ω–µ—Ç - 0)
            const holders = currentTokenData.holdersCount || 1; // –°–æ–∑–¥–∞—Ç–µ–ª—å - –ø–µ—Ä–≤—ã–π —Ö–æ–ª–¥–µ—Ä
            const txs = currentTokenData.txCount || 0;
            document.getElementById('holdersCount').innerText = holders;
            document.getElementById('txCount').innerText = txs;

            // Market Cap
            const cap = currentTokenData.marketCap || 0;
            document.getElementById('marketCapVal').innerText = Math.floor(cap).toLocaleString();

            // –ò–∫–æ–Ω–∫–∞
            if(currentTokenData.image) {
                document.getElementById('tokenIcon').src = currentTokenData.image;
                document.getElementById('tokenIcon').style.display = 'block';
                document.getElementById('tokenLetter').style.display = 'none';
            } else {
                document.getElementById('tokenIcon').style.display = 'none';
                document.getElementById('tokenLetter').innerText = tokenId[0];
                document.getElementById('tokenLetter').style.display = 'flex';
            }

            // Bonding Curve
            // –ü—Ä–æ–≥—Ä–µ—Å—Å —Å—á–∏—Ç–∞–µ–º –ø–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–∞–º (sold) –æ—Ç –º–∞–∫—Å —Å–∞–ø–ø–ª–∞—è
            const maxSupply = currentTokenData.maxSupply || TOTAL_SUPPLY;
            const sold = currentTokenData.sold || 0;
            const progress = Math.min((sold / maxSupply) * 100, 100);

            document.getElementById('bondingBar').style.width = progress + '%';
            document.getElementById('bondingText').innerText = progress.toFixed(1) + '% collected';

            if(progress >= 100) {
                document.getElementById('bondingContainer').style.display = 'none';
                document.getElementById('tradingLive').style.display = 'block';
                document.getElementById('sellBtn').style.display = 'block';
            } else {
                document.getElementById('bondingContainer').style.display = 'block';
                document.getElementById('tradingLive').style.display = 'none';
                document.getElementById('sellBtn').style.display = 'none';
            }
        }

        function renderUserPos() {
            if(!currentUserData || !currentTokenData) return;
            const bal = currentUserData.portfolio?.[tokenId] || 0;
            document.getElementById('myTokenBalance').innerText = Math.floor(bal).toLocaleString();
            // Value = Balance * Price
            document.getElementById('myTokenValue').innerText = "‚âà " + (bal * currentTokenData.price).toFixed(2);
        }

        // --- CHART.JS (–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫) ---
        function updateChart(currentPrice) {
            if(priceChart) return; // –ù–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã, —á—Ç–æ–±—ã –Ω–µ –º–µ—Ä—Ü–∞–ª–æ

            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–µ–π–∫–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã (–≤ —Ä–µ–∞–ª–µ –Ω–∞–¥–æ –±—Ä–∞—Ç—å –∏–∑ –ë–î)
            const history = [];
            let price = currentPrice;
            for(let i=0; i<24; i++) {
                history.unshift(price);
                price = price * (1 + (Math.random() * 0.06 - 0.03)); // +/- 3%
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(204, 255, 0, 0.2)');
            gradient.addColorStop(1, 'rgba(204, 255, 0, 0)');

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(24).fill(''),
                    datasets: [{
                        data: history,
                        borderColor: '#CCFF00',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { 
                            display: true, 
                            position: 'right',
                            grid: { color: '#222' },
                            ticks: { color: '#555' }
                        }
                    }
                }
            });
        }

        // --- TRADE LOGIC ---
        window.openTrade = function(type) {
            tradeType = type;
            const overlay = document.getElementById('tradeOverlay');
            document.getElementById('tradeTitle').innerText = type === 'buy' ? 'Buy' : 'Sell';
            
            const suffix = type === 'buy' ? 'BLYX' : currentTokenData.id;
            document.getElementById('tradeSuffix').innerText = suffix;
            document.getElementById('tradeInput').value = '';
            document.getElementById('tradeTotal').innerText = '0';
            
            if(type === 'buy') {
                 document.getElementById('tradeBalance').innerText = Math.floor(currentUserData.balance) + " BLYX";
            } else {
                 const bal = currentUserData.portfolio?.[tokenId] || 0;
                 document.getElementById('tradeBalance').innerText = Math.floor(bal) + " " + tokenId;
            }
            overlay.style.display = 'flex';
        }

        window.closeTrade = function() {
            document.getElementById('tradeOverlay').style.display = 'none';
        }

        window.calcTrade = function() {
            const amt = parseFloat(document.getElementById('tradeInput').value) || 0;
            const price = currentTokenData.price;
            if(tradeType === 'buy') {
                // –í–≤–æ–¥–∏–º BLYX -> –ü–æ–ª—É—á–∞–µ–º –¢–æ–∫–µ–Ω—ã
                const tokens = amt / price;
                document.getElementById('tradeTotal').innerText = Math.floor(tokens).toLocaleString();
                document.getElementById('receiveLabel').innerHTML = "You get: <span style='color:white'>" + Math.floor(tokens).toLocaleString() + "</span> " + currentTokenData.id;
            } else {
                // –í–≤–æ–¥–∏–º –¢–æ–∫–µ–Ω—ã -> –ü–æ–ª—É—á–∞–µ–º BLYX
                const blyx = amt * price;
                document.getElementById('tradeTotal').innerText = blyx.toFixed(4);
                 document.getElementById('receiveLabel').innerHTML = "You get: <span style='color:white'>" + blyx.toFixed(4) + "</span> BLYX";
            }
        }

        window.executeTrade = async function() {
            const inputVal = parseFloat(document.getElementById('tradeInput').value);
            if(!inputVal || inputVal <= 0) return;

            const currentPrice = currentTokenData.price;
            const userRef = doc(db, "users", currentUserData.id.toString());
            const tokenRef = doc(db, "tokens", tokenId);

            try {
                if(tradeType === 'buy') {
                    // Input = BLYX
                    const costBlyx = inputVal;
                    const tokensToGet = costBlyx / currentPrice;

                    if(currentUserData.balance < costBlyx) {
                        tg.showAlert("Not enough BLYX");
                        return;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º User
                    await updateDoc(userRef, {
                        balance: increment(-costBlyx),
                        [`portfolio.${tokenId}`]: increment(tokensToGet),
                        transactions: arrayUnion({ type: 'buy', token: tokenId, amount: tokensToGet, price: currentPrice, date: new Date().toISOString() })
                    });

                    // --- –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º –†—ã–Ω–æ–∫ –ø–æ —Ñ–æ—Ä–º—É–ª–µ ---
                    // 1. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º Market Cap
                    // 2. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º Sold
                    // 3. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º TxCount
                    // 4. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¶–µ–Ω—É = NewCap / TotalSupply
                    
                    const newCap = (currentTokenData.marketCap || 0) + costBlyx;
                    const newPrice = newCap / TOTAL_SUPPLY;

                    await updateDoc(tokenRef, {
                        marketCap: increment(costBlyx),
                        sold: increment(tokensToGet),
                        txCount: increment(1),
                        price: newPrice 
                    });

                    tg.showAlert("Bought successfully!");

                } else {
                    // SELL
                    const tokensToSell = inputVal;
                    const blyxToGet = tokensToSell * currentPrice;
                    const currentBal = currentUserData.portfolio?.[tokenId] || 0;

                    if(currentBal < tokensToSell) {
                        tg.showAlert("Not enough tokens");
                        return;
                    }

                    await updateDoc(userRef, {
                        balance: increment(blyxToGet),
                        [`portfolio.${tokenId}`]: increment(-tokensToSell),
                        transactions: arrayUnion({ type: 'sell', token: tokenId, amount: tokensToSell, price: currentPrice, date: new Date().toISOString() })
                    });

                    // –£–º–µ–Ω—å—à–∞–µ–º Cap –∏ –¶–µ–Ω—É
                    const newCap = Math.max(0, (currentTokenData.marketCap || 0) - blyxToGet);
                    const newPrice = newCap / TOTAL_SUPPLY;

                    await updateDoc(tokenRef, {
                        marketCap: increment(-blyxToGet),
                        txCount: increment(1),
                        price: newPrice 
                    });
                    
                    tg.showAlert("Sold successfully!");
                }
                closeTrade();
            } catch(e) {
                console.error(e);
                tg.showAlert("Error: " + e.message);
            }
        }

        function renderHistory() {
            const list = document.getElementById('txList');
            const txs = (currentUserData.transactions || []).filter(t => t.token === tokenId).reverse();
            
            list.innerHTML = '';
            if(txs.length === 0) { list.innerHTML = '<div style="text-align:center; padding:20px; color:#555;">No transactions</div>'; return; }

            txs.forEach(tx => {
                const isBuy = tx.type === 'buy' || tx.type === 'create_buy';
                const action = isBuy ? 'Buy' : 'Sell';
                const colorClass = isBuy ? 'c-green' : 'c-pink';
                const avatarClass = isBuy ? 'bg-orange-soft' : 'bg-pink-soft'; 
                const icon = isBuy ? 'üî•' : '‚ö°';

                const html = `
                <div class="trans-item">
                    <div class="ti-left">
                        <div class="ti-avatar ${avatarClass}">${icon}</div>
                        <div class="ti-info">
                            <div class="ti-addr">You</div>
                            <div class="ti-action ${colorClass}">${action} <span class="ti-time">${new Date(tx.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span></div>
                        </div>
                    </div>
                    <div class="ti-right">
                        <div class="ti-amount-row">${(tx.amount * tx.price).toFixed(2)} <img src="Sprites/Blyx.png" class="icon-blyx-right"></div>
                        <div class="ti-amount-token">${Math.floor(tx.amount).toLocaleString()} ${tokenId}</div>
                    </div>
                </div>`;
                list.innerHTML += html;
            });
        }

        initPage();
    </script>
</body>
</html>
