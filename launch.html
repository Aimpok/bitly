<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Launch</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<!-- Header -->
<div class="header-nav" id="mainHeader">
    <button class="back-btn" onclick="handleBack()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </button>
    <div class="header-title">Create Token</div>
</div>

<div class="scroll-content">
    <!-- STEP 1 -->
    <div id="step1" style="padding: 0 16px;">
        <div class="step-header">
            <div class="step-badge">1</div>
            <div class="step-title-text">Token Info</div>
        </div>

        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
            <div class="upload-circle" onclick="document.getElementById('fileInput').click()">
                <div id="previewContainer" class="upload-placeholder">+</div>
                <img id="finalAvatar" src="" style="display: none;">
            </div>
            <div>
                <div style="font-weight: 700;">Icon</div>
                <div style="font-size: 12px; color: #888;">Tap to upload</div>
            </div>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFileSelect(this)">
        </div>

        <div style="display: flex; justify-content: space-between; align-items: baseline;">
            <label class="launch-label">Name</label>
        </div>
        <div class="launch-input-box">
            <input type="text" id="tokenName" placeholder="Bitcoin" oninput="checkForm()">
        </div>

        <div style="display: flex; justify-content: space-between; align-items: baseline;">
            <label class="launch-label">Ticker (ID)</label>
        </div>
        <div class="launch-input-box">
            <input type="text" id="tokenTicker" placeholder="BTC" oninput="checkForm()" style="text-transform: uppercase;">
        </div>

        <div style="display: flex; justify-content: space-between; align-items: baseline;">
            <label class="launch-label">Description</label>
        </div>
        <div class="launch-input-box">
            <textarea id="tokenDesc" placeholder="Description..."></textarea>
        </div>
        <div style="height: 120px;"></div>
    </div>

    <!-- STEP 2 -->
    <div id="step2" style="padding: 0 16px; display: none;">
        <div class="step-header">
            <div class="step-badge">2</div>
            <div class="step-title-text">Review</div>
        </div>
        <div class="review-label">Initial Buy (Optional)</div>
        <div class="big-price-container">
            <input type="number" class="big-price-input" id="shareInput" value="0" placeholder="0" oninput="updateCalc()" style="width: 100%;">
            <img src="Sprites/Blyx.png" class="big-icon" alt="icon">
        </div>
        <div class="token-calc-text" id="tokenCalcText">
            You will receive these tokens immediately.
        </div>
        <div style="height: 200px;"></div>
    </div>
</div>

<!-- Buttons -->
<div class="fixed-bottom-bar" id="btnContainer">
    <button class="btn-white-large btn-disabled" id="continueBtn" onclick="goToStep2()">
        Continue
    </button>
</div>

<div class="fixed-bottom-bar" id="payPanel" style="display: none;">
    <div class="cost-info-row">
        <span class="cost-text-left">
            Fee: <span class="cost-highlight">200</span> + Buy: <span class="cost-highlight" id="shareCostText">0</span>
        </span>
    </div>
    <button class="btn-white-large" id="payBtn" onclick="doPay()">
        Create for <span id="btnTotalText" style="margin-left:5px;">200</span>
        <img src="Sprites/Blyx.png" class="btn-icon">
    </button>
</div>

<script type="module">
    import { initUser, getUserRef } from './user-service.js';
    import { db } from './firebase-config.js';
    import { doc, setDoc, getDoc, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#000000');

    const CREATION_FEE = 200;
    let currentUser = null;
    let base64Image = null;

    initUser().then(u => currentUser = u);

    window.checkForm = function() {
        const name = document.getElementById('tokenName').value.trim();
        const ticker = document.getElementById('tokenTicker').value.trim();
        const btn = document.getElementById('continueBtn');
        if (name.length > 0 && ticker.length > 0) btn.classList.remove('btn-disabled'); 
        else btn.classList.add('btn-disabled'); 
    }

    window.handleFileSelect = function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                base64Image = e.target.result;
                document.getElementById('finalAvatar').src = base64Image;
                document.getElementById('finalAvatar').style.display = 'block';
                document.getElementById('previewContainer').style.display = 'none';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    window.handleBack = function() {
        if(document.getElementById('step2').style.display === 'block') {
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
            document.getElementById('btnContainer').style.display = 'block';
            document.getElementById('payPanel').style.display = 'none';
        } else {
            window.history.back();
        }
    }

    window.goToStep2 = function() {
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
        document.getElementById('btnContainer').style.display = 'none';
        document.getElementById('payPanel').style.display = 'block';
        window.updateCalc();
    }

    window.updateCalc = function() {
        const buyAmount = parseFloat(document.getElementById('shareInput').value) || 0;
        const cost = buyAmount * 1; 
        document.getElementById('shareCostText').innerText = cost;
        document.getElementById('btnTotalText').innerText = (CREATION_FEE + cost);
    }

    window.doPay = async function() {
        const btn = document.getElementById('payBtn');
        if(btn.disabled) return;
        
        const name = document.getElementById('tokenName').value.trim();
        const ticker = document.getElementById('tokenTicker').value.trim().toUpperCase();
        const desc = document.getElementById('tokenDesc').value;
        const buyAmount = parseFloat(document.getElementById('shareInput').value) || 0;
        const totalCost = CREATION_FEE + buyAmount;

        // Блокируем кнопку
        btn.disabled = true;
        btn.innerHTML = 'Creating...';

        try {
            // 1. Проверка существования
            const tokenRef = doc(db, "tokens", ticker);
            const tokenSnap = await getDoc(tokenRef);
            if(tokenSnap.exists()) {
                tg.showAlert("Ticker already exists!");
                btn.disabled = false;
                btn.innerHTML = 'Try again';
                return;
            }

            // 2. Проверка баланса
            const userRef = getUserRef();
            const userSnap = await getDoc(userRef);
            const balance = userSnap.data().balance || 0;

            if(balance < totalCost) {
                tg.showAlert(`Not enough BLYX. Need ${totalCost}.`);
                btn.disabled = false;
                btn.innerHTML = 'Insufficient funds';
                return;
            }

            // 3. Создаем токен
            await setDoc(tokenRef, {
                id: ticker,
                name: name,
                description: desc,
                image: base64Image,
                price: 1.0,
                change: 0,
                ownerId: currentUser.id,
                createdAt: new Date().toISOString()
            });

            // 4. Списываем средства
            const updates = { balance: increment(-totalCost) };
            if(buyAmount > 0) {
                updates[`portfolio.${ticker}`] = increment(buyAmount);
                updates.transactions = arrayUnion({
                    type: 'create_buy', token: ticker, amount: buyAmount, price: 1.0, date: new Date().toISOString()
                });
            }
            await updateDoc(userRef, updates);

            // 5. Редирект на страницу токена
            location.href = `crypto_info.html?id=${ticker}`;

        } catch(e) {
            console.error(e);
            tg.showAlert("Error: " + e.message);
            btn.disabled = false;
            btn.innerHTML = 'Error';
        }
    }
</script>
</body>
</html>
