<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Launch</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

    <!-- Header -->
    <div class="header-nav" id="mainHeader">
        <button class="back-btn" onclick="handleBack()">
            <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <div class="header-title">Create Token</div>
    </div>

    <!-- Scroll Content -->
    <div class="scroll-content">
        
        <!-- ===================== STEP 1: INFO ===================== -->
        <div id="step1" style="padding: 0 16px;">
            <div class="step-header">
                <div class="step-badge">1</div>
                <div class="step-title-text">Token Info</div>
            </div>

            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
                <div class="upload-circle" onclick="document.getElementById('fileInput').click()">
                    <div id="previewContainer" class="upload-placeholder">+</div>
                    <img id="finalAvatar" src="" style="display: none;">
                </div>
                <div>
                    <div style="font-weight: 700;">Icon</div>
                    <div style="font-size: 12px; color: #888;">JPG, PNG, GIF</div>
                </div>
                <input type="file" id="fileInput" hidden accept="image/*" onchange="startCropper(this)">
            </div>

            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                <label class="launch-label">Name</label>
                <span class="char-count">20</span>
            </div>
            <div class="launch-input-box">
                <!-- Валидация при вводе -->
                <input type="text" id="tokenName" placeholder="Bitcoin" oninput="checkForm()">
            </div>

            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                <label class="launch-label">Ticker</label>
                <span class="char-count">10</span>
            </div>
            <div class="launch-input-box">
                <!-- Валидация при вводе -->
                <input type="text" id="tokenTicker" placeholder="BTC" oninput="checkForm()">
            </div>

            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                <label class="launch-label">Description</label>
                <span class="char-count">240</span>
            </div>
            <div class="launch-input-box">
                <textarea id="tokenDesc" placeholder="Description..."></textarea>
            </div>

            <div style="height: 120px;"></div>
        </div>

        <!-- ===================== STEP 2: PAYMENT ===================== -->
        <div id="step2" style="padding: 0 16px; display: none;">
            <div class="step-header">
                <div class="step-badge">2</div>
                <div class="step-title-text">Review</div>
            </div>

            <div class="review-label">Your share (optional)</div>

            <div class="big-price-container">
                <span id="widthMachine"></span>
                <input type="number" class="big-price-input" id="shareInput" value="0" placeholder="0" oninput="updateCalc()">
                <img src="Sprites/Blyx.png" class="big-icon" alt="icon">
            </div>

            <div class="token-calc-text" id="tokenCalcText">
                0 TOKENNAME (0% of total supply)
            </div>

            <div style="height: 200px;"></div>
        </div>

    </div>

    <!-- ===================== FIXED BUTTONS ===================== -->
    
    <!-- Панель 1 (Изначально серая/disabled) -->
    <div class="fixed-bottom-bar" id="btnContainer">
        <button class="btn-white-large btn-disabled" id="continueBtn" onclick="goToStep2()">
            Continue
        </button>
    </div>

    <!-- Панель 2 -->
    <div class="fixed-bottom-bar" id="payPanel" style="display: none;">
        <div class="cost-info-row">
            <span class="cost-text-left">
                Fee: <span class="cost-highlight">200</span> + Share: <span class="cost-highlight" id="shareCostText">0</span>
            </span>
        </div>
        <button class="btn-white-large" onclick="doPay()">
            <span id="btnTotalText">200</span>
            <img src="Sprites/Blyx.png" class="btn-icon">
        </button>
    </div>

    <!-- ===================== CROPPER OVERLAY ===================== -->
    <div id="cropperOverlay" class="cropper-overlay">
        <div class="cropper-container" id="gestureArea">
            <img id="cropperImage" src="">
            <div class="cropper-mask"></div>
        </div>
        <div class="cropper-footer">
            <button class="btn-text" onclick="cancelCropper()">Cancel</button>
            <button class="btn-pill-white" onclick="finishCropper()">Done</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');

        const CREATION_FEE = 200;
        const MAX_SHARE_BLYX = 10000; // Изменено на 10,000

        // --- VALIDATION ---
        function checkForm() {
            const name = document.getElementById('tokenName').value.trim();
            const ticker = document.getElementById('tokenTicker').value.trim();
            const btn = document.getElementById('continueBtn');

            if (name.length > 0 && ticker.length > 0) {
                btn.classList.remove('btn-disabled'); 
            } else {
                btn.classList.add('btn-disabled'); 
            }
        }

        // --- NAVIGATION ---
        function handleBack() {
            if(document.getElementById('step2').style.display === 'block') {
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step1').style.display = 'block';
                document.getElementById('btnContainer').style.display = 'block';
                document.getElementById('payPanel').style.display = 'none';
            } else {
                location.href = 'markets.html';
            }
        }

        function goToStep2() {
            const name = document.getElementById('tokenName').value;
            const ticker = document.getElementById('tokenTicker').value;
            
            if(!name || !ticker) return;

            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            document.getElementById('btnContainer').style.display = 'none';
            document.getElementById('payPanel').style.display = 'block';
            
            updateCalc();
        }

        function updateCalc() {
            const name = document.getElementById('tokenName').value || 'TOKEN';
            const inputEl = document.getElementById('shareInput');
            let share = parseFloat(inputEl.value);

            if (isNaN(share) || share < 0) share = 0;

            if (share > MAX_SHARE_BLYX) {
                share = MAX_SHARE_BLYX;
                inputEl.value = MAX_SHARE_BLYX;
            }

            let valStr = inputEl.value;
            if(valStr === '') valStr = ''; 
            const machine = document.getElementById('widthMachine');
            machine.innerHTML = valStr || '0'; 
            const newWidth = machine.offsetWidth + 20; 
            inputEl.style.width = newWidth + 'px';

            // Процент считается исходя из 10,000
            let percent = (share / MAX_SHARE_BLYX) * 30;
            if (percent > 30) percent = 30;
            
            // Количество токенов (примерная логика)
            const tokens = share * 60000; 
            
            document.getElementById('tokenCalcText').innerText = 
                `${tokens.toLocaleString()} ${name.toUpperCase()} (${percent.toFixed(2)}% of total supply)`;

            document.getElementById('shareCostText').innerText = share;
            const total = CREATION_FEE + share;
            document.getElementById('btnTotalText').innerText = total;
        }

        function doPay() {
            const share = parseFloat(document.getElementById('shareInput').value) || 0;
            const total = CREATION_FEE + share;
            tg.showConfirm(`Pay ${total} BLYX?`, (ok) => {
                if(ok) {
                    tg.showAlert("Token Created Successfully!");
                    location.href = 'wallet.html';
                }
            });
        }

        // --- CROPPER LOGIC ---
        let state = { scale: 1, pX: 0, pY: 0, startX: 0, startY: 0, lastScale: 1, isDragging: false, initialDist: 0 };
        const overlay = document.getElementById('cropperOverlay');
        const img = document.getElementById('cropperImage');
        const gestureArea = document.getElementById('gestureArea');

        function startCropper(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    img.src = e.target.result;
                    img.onload = () => {
                        state = { scale: 1, pX: 0, pY: 0, startX: 0, startY: 0, lastScale: 1, isDragging: false, initialDist: 0 };
                        updateTransform();
                        overlay.style.display = 'flex';
                        // Скрываем кнопку
                        document.getElementById('btnContainer').style.display = 'none';
                    };
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateTransform() {
            img.style.transform = `translate(${state.pX}px, ${state.pY}px) scale(${state.scale})`;
        }

        gestureArea.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                state.isDragging = true;
                state.startX = e.touches[0].clientX - state.pX;
                state.startY = e.touches[0].clientY - state.pY;
            } else if (e.touches.length === 2) {
                state.isDragging = false;
                state.initialDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                state.lastScale = state.scale;
            }
        });

        gestureArea.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (e.touches.length === 1 && state.isDragging) {
                state.pX = e.touches[0].clientX - state.startX;
                state.pY = e.touches[0].clientY - state.startY;
                updateTransform();
            } else if (e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                state.scale = Math.max(0.5, Math.min(5, state.lastScale * (dist / state.initialDist)));
                updateTransform();
            }
        });

        gestureArea.addEventListener('touchend', () => { state.isDragging = false; });

        function cancelCropper() {
            overlay.style.display = 'none';
            document.getElementById('fileInput').value = "";
            document.getElementById('btnContainer').style.display = 'block';
        }

        function finishCropper() {
            document.getElementById('finalAvatar').src = img.src;
            document.getElementById('finalAvatar').style.display = 'block';
            document.getElementById('previewContainer').style.display = 'none';
            overlay.style.display = 'none';
            document.getElementById('btnContainer').style.display = 'block';
        }
    </script>
</body>
</html>