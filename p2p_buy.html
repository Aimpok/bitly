<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Buy P2P</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* === LOADER STYLES === */
        #globalLoader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 99999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        #globalLoader.loaded { opacity: 0; visibility: hidden; pointer-events: none; }
        .custom-spinner {
            width: 40px; height: 40px; border-radius: 50%;
            border: 4px solid #333; border-top-color: #ffffff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="globalLoader"><div class="custom-spinner"></div></div>

    <div class="header-nav">
        <button class="back-btn" onclick="window.history.back()"><svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
        <div class="header-title" id="pageTitle">Buy</div>
    </div>

    <div style="padding: 0 16px;">
        <div style="background:#111; border:1px solid #333; border-radius:16px; padding:16px; margin-bottom:20px;">
            <div style="font-size:12px; color:#888; margin-bottom:4px;">Price</div>
            <div style="font-size:24px; font-weight:700; color:white; display:flex; align-items:center; gap:6px;">
                <span id="priceVal">0</span> <img src="Sprites/Blyx.png" style="width:20px;">
            </div>
            <div style="width:100%; height:1px; background:#222; margin:12px 0;"></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <span style="color:#888; font-size:13px;">Seller</span>
                <span style="color:white; font-weight:600; font-size:13px;" id="sellerName">...</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <span style="color:#888; font-size:13px;">Available</span>
                <span style="color:white; font-weight:600; font-size:13px;" id="availVal">0</span>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span style="color:#888; font-size:13px;">Limits (BLYX)</span>
                <span style="color:white; font-weight:600; font-size:13px;" id="limitsVal">0 - 0</span>
            </div>
        </div>

        <div class="input-wrapper">
            <input type="text" inputmode="decimal" id="amountInput" placeholder="Amount" oninput="handleInput(this)">
            <div class="input-suffix" id="tokenSuffix">TOKEN</div>
        </div>

        <div id="errorText" class="error-text"></div>
    </div>

    <div class="fixed-bottom-bar">
        <button class="btn-white-large btn-disabled" id="confirmBtn" onclick="doBuy()">
            <span id="btnCost">0</span> 
            <img src="Sprites/Blyx.png" style="width:20px; height:20px; object-fit:contain; margin-left:6px;">
        </button>
    </div>

    <script type="module">
        import { initUser, getTgUser } from './user-service.js';
        import { db } from './firebase-config.js';
        import { doc, getDoc, runTransaction, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');
        
        const loader = document.getElementById('globalLoader');
        const orderId = new URLSearchParams(window.location.search).get('oid');
        let orderData = null;
        let currentUser = null;

        function formatDisplay(num) {
            if (num === undefined || num === null) return "0";
            let parts = num.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            if (parts[1]) return parts[0] + "." + parts[1].substring(0, 6);
            return parts[0];
        }

        window.handleInput = function(el) {
            let raw = el.value.replace(/[^0-9.]/g, '');
            if ((raw.match(/\./g) || []).length > 1) raw = raw.replace(/\.$/, '');
            if(raw.endsWith('.')) { el.value = raw; updateButton(); return; }
            if(!raw) { el.value = ""; updateButton(); return; }
            const parts = raw.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            if(parts[1] && parts[1].length > 6) parts[1] = parts[1].substring(0,6);
            el.value = parts.join('.');
            updateButton();
        }

        function getRawAmount() {
            return parseFloat(document.getElementById('amountInput').value.replace(/\s/g, '')) || 0;
        }

        async function init() {
            try {
                currentUser = await initUser();
                const snap = await getDoc(doc(db, "orders", orderId));
                if(!snap.exists()) { alert("Order not found"); window.history.back(); return; }
                orderData = { id: snap.id, ...snap.data() };
                render();
            } catch(e) { console.error(e); }
            if(loader) loader.classList.add('loaded');
        }

        function render() {
            document.getElementById('pageTitle').innerText = `Buy ${orderData.tokenId}`;
            document.getElementById('tokenSuffix').innerText = orderData.tokenId;
            let displayPrice = orderData.price < 0.01 ? orderData.price.toFixed(8) : orderData.price.toFixed(4);
            document.getElementById('priceVal').innerText = displayPrice;
            document.getElementById('sellerName').innerText = orderData.sellerName;
            document.getElementById('availVal').innerText = formatDisplay(orderData.amount);
            const max = orderData.maxLimit || (orderData.amount * orderData.price);
            document.getElementById('limitsVal').innerText = `${formatDisplay(Math.floor(orderData.minLimit))} - ${formatDisplay(Math.floor(max))}`;
        }

        window.updateButton = function() {
            const amount = getRawAmount();
            const cost = amount * orderData.price;
            
            const btn = document.getElementById('confirmBtn');
            const err = document.getElementById('errorText');
            document.getElementById('btnCost').innerText = cost > 0 ? formatDisplay(cost) : "0";
            
            btn.classList.add('btn-disabled');
            err.innerText = "";

            if(amount <= 0) return;

            const maxLimit = orderData.maxLimit || (orderData.amount * orderData.price);
            
            if(cost < orderData.minLimit) { err.innerText = `Min purchase: ${formatDisplay(orderData.minLimit)} BLYX`; return; }
            if(cost > maxLimit) { err.innerText = `Max purchase: ${formatDisplay(maxLimit)} BLYX`; return; }
            if(amount > orderData.amount) { err.innerText = "Not enough tokens available"; return; }
            if(currentUser.balance < cost) { err.innerText = "Insufficient BLYX balance"; return; }

            btn.classList.remove('btn-disabled');
        }

        window.doBuy = async function() {
            const amount = getRawAmount();
            if(!amount) return;
            const cost = amount * orderData.price;

            tg.showConfirm(`Pay ${formatDisplay(cost)} BLYX for ${formatDisplay(amount)} ${orderData.tokenId}?`, async (ok) => {
                if(ok) {
                    if(loader) loader.classList.remove('loaded');
                    try {
                        await runTransaction(db, async (t) => {
                            const orderRef = doc(db, "orders", orderId);
                            const buyerRef = doc(db, "users", currentUser.id.toString());
                            const sellerRef = doc(db, "users", orderData.sellerId);
                            const tokenRef = doc(db, "tokens", orderData.tokenId);

                            const oSnap = await t.get(orderRef);
                            if(!oSnap.exists()) throw "Order expired";
                            const currentOrder = oSnap.data();
                            if(currentOrder.amount < amount) throw "Not enough tokens";

                            const newAmount = currentOrder.amount - amount;
                            if(newAmount < 0.000001) t.delete(orderRef);
                            else t.update(orderRef, { amount: newAmount });

                            t.update(buyerRef, {
                                balance: increment(-cost),
                                [`portfolio.${orderData.tokenId}`]: increment(amount),
                                transactions: arrayUnion({ type: 'p2p_buy', price: orderData.price, amount: amount, date: new Date().toISOString() })
                            });
                            // +1 к сделкам продавца
                            t.update(sellerRef, {
                                balance: increment(cost),
                                tradesCount: increment(1), // Увеличение кол-ва сделок
                                transactions: arrayUnion({ type: 'p2p_sold', price: orderData.price, amount: amount, date: new Date().toISOString() })
                            });
                            t.update(tokenRef, {
                                price: orderData.price,
                                txCount: increment(1),
                                transactions: arrayUnion({ price: orderData.price, date: new Date().toISOString() })
                            });
                        });
                        tg.showAlert("Success!");
                        window.history.back();
                    } catch(e) {
                        if(loader) loader.classList.add('loaded');
                        tg.showAlert("Error: " + e);
                    }
                }
            });
        }
        init();
    </script>
</body>
</html>
