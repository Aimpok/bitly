<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Buy Token</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* === LOADER STYLES === */
        #globalLoader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 99999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        #globalLoader.loaded { opacity: 0; visibility: hidden; pointer-events: none; }
        .custom-spinner {
            width: 40px; height: 40px; border-radius: 50%;
            border: 4px solid #333; border-top-color: #ffffff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .info-card {
            background:#111; border:1px solid #333; border-radius:16px; padding:16px; margin-bottom:20px;
        }
        .progress-bar-bg {
            width: 100%; height: 6px; background: #333; border-radius: 4px; margin-top: 10px; overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%; background: #FFFFFF; width: 0%; transition: width 0.3s;
        }
        
        /* Класс для красного текста ошибки */
        .text-error { color: #FF3B30 !important; font-weight: 600; }
    </style>
</head>
<body>

    <!-- ЗАГРУЗЧИК -->
    <div id="globalLoader"><div class="custom-spinner"></div></div>

    <div class="header-nav">
        <button class="back-btn" onclick="window.history.back()"><svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
        <div class="header-title" id="pageTitle">Buy</div>
    </div>

    <div style="padding: 0 16px;">
        
        <!-- Info Block -->
        <div class="info-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img id="tokenImg" src="" style="width:32px; height:32px; border-radius:50%; object-fit:cover; display:none;">
                    <div id="tokenLetter" style="width:32px; height:32px; border-radius:50%; background:#333; display:flex; align-items:center; justify-content:center; font-weight:700;">?</div>
                    <div>
                        <div style="font-weight:700; font-size:16px;" id="tokenTicker">...</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:12px; color:#888;">Price</div>
                    <div style="font-weight:700;" id="priceVal">0</div>
                </div>
            </div>

            <div style="width:100%; height:1px; background:#222; margin:10px 0;"></div>

            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:5px;">
                <span style="color:#888;">Progress</span>
                <span style="color:#fff; font-weight:600;" id="progressText">0%</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressFill"></div>
            </div>
            <div style="text-align:right; font-size: 11px; color: #666; margin-top: 4px;">
                Remaining: <span id="supplyLeft">...</span>
            </div>
        </div>

        <!-- Input -->
        <div class="input-wrapper">
            <input type="text" inputmode="decimal" id="amountInput" placeholder="Amount (Tokens)" oninput="handleInput(this)">
            <div class="input-suffix" id="tokenSuffix">TOKEN</div>
        </div>
        
        <div style="display:flex; justify-content:space-between; margin-top:10px; padding:0 5px; align-items: flex-start;">
            <!-- Баланс / Ошибки -->
            <span id="balanceInfo" style="font-size:12px; color:#666;">Checking balance...</span>
            
            <!-- Стоимость -->
            <span style="font-size:12px; color:#fff;">Cost: <span id="costVal" style="font-weight:700;">0</span> BLYX</span>
        </div>
    </div>

    <div class="fixed-bottom-bar">
        <button class="btn-white-large btn-disabled" id="confirmBtn" onclick="doBuy()">
            <span id="btnLabel">Pay 0</span> 
            <img src="Sprites/Blyx.png" style="width:20px; height:20px; object-fit:contain; margin-left:6px;">
        </button>
    </div>

    <script type="module">
        import { initUser } from './user-service.js';
        import { db } from './firebase-config.js';
        // ДОБАВЛЕН runTransaction для безопасной покупки
        import { doc, getDoc, runTransaction, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');
        
        const loader = document.getElementById('globalLoader');
        const tokenId = new URLSearchParams(window.location.search).get('id');
        
        let tokenData = null;
        let currentUser = null;
        
        const TOTAL_SUPPLY = 1000000000; // 1 Миллиард общий лимит
        const MIN_COST_BLYX = 100;       // Мин. покупка 100 BLYX

        function formatDisplay(num) {
            if (num === undefined || num === null) return "0";
            let parts = num.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            if (parts[1]) return parts[0] + "." + parts[1].substring(0, 6);
            return parts[0];
        }

        window.handleInput = function(el) {
            let raw = el.value.replace(/[^0-9.]/g, '');
            if ((raw.match(/\./g) || []).length > 1) raw = raw.replace(/\.$/, '');
            if(raw.endsWith('.')) { el.value = raw; updateButton(); return; }
            if(!raw) { el.value = ""; updateButton(); return; }
            const parts = raw.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            if(parts[1] && parts[1].length > 6) parts[1] = parts[1].substring(0,6);
            el.value = parts.join('.');
            updateButton();
        }

        function getRawAmount() {
            return parseFloat(document.getElementById('amountInput').value.replace(/\s/g, '')) || 0;
        }

        async function init() {
            try {
                currentUser = await initUser();
                document.getElementById('balanceInfo').innerText = `Balance: ${formatDisplay(Math.floor(currentUser.balance))} BLYX`;

                const snap = await getDoc(doc(db, "tokens", tokenId));
                if(!snap.exists()) { alert("Token not found"); window.history.back(); return; }
                
                tokenData = snap.data();
                render();
            } catch(e) { console.error(e); }
            if(loader) loader.classList.add('loaded');
        }

        function render() {
            document.getElementById('pageTitle').innerText = `Buy ${tokenData.name}`;
            document.getElementById('tokenTicker').innerText = tokenData.id;
            document.getElementById('tokenSuffix').innerText = tokenData.id; 
            
            if(tokenData.image) {
                document.getElementById('tokenImg').src = tokenData.image;
                document.getElementById('tokenImg').style.display = 'block';
                document.getElementById('tokenLetter').style.display = 'none';
            } else {
                document.getElementById('tokenLetter').innerText = tokenData.id[0];
            }

            const price = tokenData.price < 0.01 ? tokenData.price.toFixed(8) : tokenData.price.toFixed(4);
            document.getElementById('priceVal').innerText = price + " BLYX";

            // Глобальный счетчик проданных
            const sold = tokenData.sold || 0;
            const remaining = TOTAL_SUPPLY - sold;
            const progress = Math.min((sold / TOTAL_SUPPLY) * 100, 100);
            
            document.getElementById('progressText').innerText = progress.toFixed(2) + "%";
            document.getElementById('progressFill').style.width = progress + "%";
            document.getElementById('supplyLeft').innerText = formatDisplay(Math.floor(remaining));
        }

        window.updateButton = function() {
            const tokenAmount = getRawAmount(); 
            const btn = document.getElementById('confirmBtn');
            const balanceLabel = document.getElementById('balanceInfo');
            
            const cost = tokenAmount * tokenData.price;
            
            document.getElementById('costVal').innerText = formatDisplay(cost);
            document.getElementById('btnLabel').innerText = cost > 0 ? formatDisplay(cost) : "0";

            balanceLabel.className = "";
            balanceLabel.innerText = `Balance: ${formatDisplay(Math.floor(currentUser.balance))} BLYX`;
            btn.classList.add('btn-disabled');

            if(tokenAmount <= 0) return;

            // 1. Проверка Баланса
            if(cost > currentUser.balance) {
                balanceLabel.innerText = "Insufficient BLYX balance";
                balanceLabel.className = "text-error";
                return;
            }

            // 2. Мин. сумма покупки
            if (cost < MIN_COST_BLYX) {
                balanceLabel.innerText = `Minimum purchase is ${MIN_COST_BLYX} BLYX`;
                balanceLabel.className = "text-error";
                return;
            }

            // 3. Проверка Глобального Остатка (UI)
            const sold = tokenData.sold || 0;
            const remainingSupply = TOTAL_SUPPLY - sold;
            
            if (tokenAmount > remainingSupply) {
                balanceLabel.innerText = `Only ${formatDisplay(Math.floor(remainingSupply))} tokens left`;
                balanceLabel.className = "text-error";
                return;
            }

            // 4. Проверка Личного Лимита (30%)
            const myHoldings = currentUser.portfolio?.[tokenId] || 0;
            const maxAllowed = TOTAL_SUPPLY * 0.30;
            const isCreator = tokenData.ownerId === currentUser.id.toString(); 

            if (!isCreator && (myHoldings + tokenAmount) > maxAllowed) {
                balanceLabel.innerText = `Max limit reached (30%)`;
                balanceLabel.className = "text-error";
                return;
            }

            btn.classList.remove('btn-disabled');
        }

        window.doBuy = async function() {
            const tokenAmount = getRawAmount(); 
            if(!tokenAmount) return;

            // Приблизительная стоимость для подтверждения (реальная пересчитается в транзакции)
            const approxCost = tokenAmount * tokenData.price; 
            
            tg.showConfirm(`Buy ${formatDisplay(tokenAmount)} ${tokenId}?`, async (ok) => {
                if(ok) {
                    if(loader) loader.classList.remove('loaded');
                    try {
                        const userRef = doc(db, "users", currentUser.id.toString());
                        const tokenRef = doc(db, "tokens", tokenId);

                        // --- ТРАНЗАКЦИЯ ДЛЯ БЕЗОПАСНОЙ ПОКУПКИ ---
                        await runTransaction(db, async (t) => {
                            // 1. Читаем свежие данные токена
                            const tDoc = await t.get(tokenRef);
                            if (!tDoc.exists()) throw "Token does not exist!";
                            const freshTokenData = tDoc.data();
                            
                            // 2. Проверяем, не купил ли кто-то токены перед нами
                            const currentSold = freshTokenData.sold || 0;
                            const newSold = currentSold + tokenAmount;
                            
                            // ЖЕСТКАЯ ПРОВЕРКА НА 1 МЛРД
                            if (newSold > TOTAL_SUPPLY) {
                                throw `Not enough tokens! Only ${formatDisplay(TOTAL_SUPPLY - currentSold)} left.`;
                            }

                            // 3. Читаем баланс пользователя
                            const uDoc = await t.get(userRef);
                            if (!uDoc.exists()) throw "User error";
                            const userData = uDoc.data();
                            const currentBalance = userData.balance || 0;
                            const freshPrice = freshTokenData.price;
                            const finalCost = tokenAmount * freshPrice;

                            if (currentBalance < finalCost) {
                                throw "Insufficient funds (Price might have changed).";
                            }

                            // 4. Логика Bonding Curve (цены)
                            const newCap = (freshTokenData.marketCap || 0) + finalCost;
                            const newPrice = newCap / TOTAL_SUPPLY;

                            // 5. Запись изменений
                            t.update(userRef, {
                                balance: increment(-finalCost),
                                [`portfolio.${tokenId}`]: increment(tokenAmount),
                                transactions: arrayUnion({ 
                                    type: 'buy', 
                                    token: tokenId, 
                                    amount: tokenAmount, 
                                    cost: finalCost, 
                                    price: freshPrice, 
                                    date: new Date().toISOString() 
                                })
                            });

                            t.update(tokenRef, {
                                marketCap: increment(finalCost),
                                sold: increment(tokenAmount),
                                txCount: increment(1),
                                price: newPrice,
                                transactions: arrayUnion({ 
                                    price: newPrice, 
                                    date: new Date().toISOString() 
                                })
                            });
                        });

                        tg.showAlert("Success!");
                        window.history.back(); 
                    } catch(e) {
                        if(loader) loader.classList.add('loaded');
                        tg.showAlert("Error: " + e); // e может быть строкой из throw
                    }
                }
            });
        }

        init();
    </script>
</body>
</html>
