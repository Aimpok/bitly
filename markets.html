<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Markets</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Лоадер как в Index */
        #globalLoader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 99999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        #globalLoader.loaded { opacity: 0; visibility: hidden; pointer-events: none; }
        .custom-spinner {
            width: 40px; height: 40px; border-radius: 50%;
            border: 4px solid #333; border-top-color: #ffffff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- Лоадер -->
<div id="globalLoader"><div class="custom-spinner"></div></div>

<!-- Header -->
<div class="market-header">
    <div class="market-title-big">Market</div>
    <button class="btn-launch-pill" onclick="location.href='launch.html'">Launch token</button>
</div>

<!-- Search Bar -->
<div class="search-container">
    <div class="search-input-box">
        <svg class="search-icon icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" class="search-input" id="searchInput" placeholder="Search">
    </div>
</div>

<!-- Market List -->
<div class="market-list" id="marketList">
    <div style="text-align: center; padding: 20px; color: #555;">Loading markets...</div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <!-- 1. Home -->
    <div class="nav-item" onclick="location.href='index.html'">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </div>

    <!-- 2. Earn (Монетка $) -->
    <div class="nav-item" onclick="location.href='Earn.html'">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="9"></circle>
            <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="10" font-weight="800" fill="currentColor" stroke="none" style="font-family: Arial;">$</text>
        </svg>
    </div>

    <!-- 3. Markets (Центр - Active для этой страницы) -->
    <div class="nav-trade-circle" onclick="location.href='markets.html'">
        <svg class="icon" style="color:black;" viewBox="0 0 24 24">
            <polyline points="17 1 21 5 17 9"></polyline>
            <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
            <polyline points="7 23 3 19 7 15"></polyline>
            <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
        </svg>
    </div>

    <!-- 4. Messages (Колокольчик) -->
    <div class="nav-item" onclick="location.href='messages.html'">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
    </div>

    <!-- 5. Wallet -->
    <div class="nav-item" onclick="location.href='wallet.html'">
        <svg class="icon" viewBox="0 0 24 24">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
            <line x1="1" y1="10" x2="23" y2="10"></line>
        </svg>
    </div>
</div>

<script type="module">
    import { initUser, subscribeToMarket, initMarketDataIfNeeded } from './user-service.js';

    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#000000');

    // Лоадер
    const loader = document.getElementById('globalLoader');

    let allTokens = []; 

    // FORMATTER
    function formatPrice(val) {
        if(!val || val === 0) return "0";
        return val < 0.01 ? val.toFixed(8).replace(/\.?0+$/, "") : val.toFixed(4);
    }

    async function initMarkets() {
        try {
            await initUser();
            await initMarketDataIfNeeded(); 

            subscribeToMarket((tokens) => {
                allTokens = tokens; 
                filterMarkets(); 
                
                // Убираем лоадер когда данные пришли
                if(loader && !loader.classList.contains('loaded')) {
                    loader.classList.add('loaded');
                }
            });
        } catch(e) { console.error(e); }
    }

    const listContainer = document.getElementById('marketList');
    const searchInput = document.getElementById('searchInput');

    function renderList(items) {
        listContainer.innerHTML = "";
        
        if(items.length === 0) {
             listContainer.innerHTML = '<div style="text-align: center; color: #555; padding: 20px;">No tokens found</div>';
             return;
        }

        items.forEach(coin => {
            let changeVal = (coin.change !== undefined && coin.change !== null) ? coin.change : 0;
            const isPositive = changeVal >= 0;
            const changeClass = isPositive ? 'color-green' : 'color-red';
            const sign = isPositive ? '+' : '';
            const displayChange = Math.abs(changeVal).toFixed(2);

            let iconHtml = '';
            if (coin.image) {
                iconHtml = `<img src="${coin.image}" class="coin-img" alt="${coin.name}">`;
            } else {
                const iconLetter = coin.id.charAt(0).toUpperCase();
                iconHtml = `<span class="coin-letter">${iconLetter}</span>`;
            }

            const displayPrice = formatPrice(coin.price);

            const html = `
            <div class="market-item" onclick="location.href='crypto_info.html?id=${coin.id}'">
                <div class="market-left">
                    <div class="coin-avatar">${iconHtml}</div>
                    <div class="market-info">
                        <div class="market-pair">${coin.id}</div>
                        <div class="t-sub">${coin.name}</div>
                    </div>
                </div>
                <div class="market-right">
                    <div class="market-price-row">
                        ${displayPrice}
                        <img src="Sprites/Blyx.png" style="width: 14px; height: 14px; object-fit: contain;">
                    </div>
                    <div class="market-change ${changeClass}">${sign}${displayChange}%</div>
                </div>
            </div>
            `;
            listContainer.innerHTML += html;
        });
    }

    window.filterMarkets = function() {
        const query = searchInput.value.toLowerCase();
        const filtered = allTokens.filter(coin => 
            coin.name.toLowerCase().includes(query) || 
            coin.id.toLowerCase().includes(query)
        );
        renderList(filtered);
    }

    searchInput.addEventListener('input', window.filterMarkets);
    initMarkets();
</script>
</body>
</html>
