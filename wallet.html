<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wallet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            margin: 0 auto;
            max-width: 480px;
            font-family: 'Inter', sans-serif;
            padding-bottom: 100px !important;
        }

        .wh-coin-icon { width: 18px; height: 18px; object-fit: contain; border-radius: 50%; }
        .tabs-scroll { margin-bottom: 20px; border-bottom: none !important; }
        .hidden { display: none !important; }
        .wh-item { border-bottom: 1px solid #111 !important; }

        /* --- ПАНЕЛЬ НАВИГАЦИИ --- */
        .bottom-nav {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important; 
            max-width: 480px !important; 
            margin: 0 auto !important;   
            transform: none !important; 
            border: none !important;     
            border-radius: 0 !important; 
            background: #000000 !important; 
            display: grid !important;
            grid-template-columns: repeat(5, 1fr) !important;
            align-items: center !important;
            justify-items: center !important;
            height: 70px !important;
            padding-bottom: env(safe-area-inset-bottom, 20px) !important; 
            z-index: 9999 !important;
            box-sizing: border-box !important;
        }

        .nav-item {
            width: 100% !important;
            height: 100% !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            opacity: 0.5;
            transition: opacity 0.2s;
            cursor: pointer;
        }

        .nav-item.active { opacity: 1 !important; }

        .nav-trade-circle {
            width: 48px !important;
            height: 48px !important;
            background: #ffffff !important;
            border-radius: 50% !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            transform: translateY(-5px) !important; 
            cursor: pointer;
        }

        .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }
    </style>
</head>
<body>

<div class="balance-card">
    <div class="balance-label">Total Assets</div>
    <div class="balance-val" style="display: flex; align-items: center; gap: 8px;">
        <span id="totalAssetsDisplay">0</span>
        <img src="Sprites/Blyx.png" style="width: 32px; height: 32px; object-fit: contain; margin-top: 4px;" alt="Blyx">
    </div>
</div>

<div class="actions-row">
    <div class="action-btn" onclick="location.href='deposit.html'">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span class="action-label">Deposit</span>
    </div>
    <div class="action-btn" onclick="location.href='transfer.html'">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <polyline points="12 5 19 12 12 19"></polyline>
        </svg>
        <span class="action-label">Send</span>
    </div>
</div>

<div class="tabs-scroll">
    <div class="tab-link active" onclick="switchTab('portfolio', this)">Portfolio</div>
    <div class="tab-link" onclick="switchTab('goods', this)">Goods</div>
    <div class="tab-link" onclick="switchTab('history', this)">History</div>
</div>

<div style="padding: 0 16px;">
    <!-- 1. PORTFOLIO -->
    <div id="tab-portfolio">
        <div class="portfolio-grid" id="portfolioGrid">
            <div style="color: #666; font-size: 14px; text-align:center; grid-column:1/-1;">Loading...</div>
        </div>
    </div>

    <!-- 2. GOODS (Обновлено под стиль P2P) -->
    <div id="tab-goods" class="hidden">
        <div id="goodsList">
            <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">No active sell orders</div>
        </div>
    </div>

    <!-- 3. HISTORY -->
    <div id="tab-history" class="hidden">
        <div id="historyList">
            <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">No transactions</div>
        </div>
    </div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
    <div class="nav-item" onclick="location.href='index.html'">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </div>
    <div class="nav-item" onclick="location.href='Earn.html'">
        <svg class="icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="9"></circle>
            <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="10" font-weight="800" fill="currentColor" stroke="none">$</text>
        </svg>
    </div>
    <div class="nav-trade-circle" onclick="location.href='markets.html'">
        <svg class="icon" style="color:black;" viewBox="0 0 24 24">
            <polyline points="17 1 21 5 17 9"></polyline>
            <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
            <polyline points="7 23 3 19 7 15"></polyline>
            <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
        </svg>
    </div>
    <div class="nav-item" onclick="location.href='messages.html'">
        <svg class="icon" viewBox="0 0 24 24">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
    </div>
    <div class="nav-item active">
        <svg class="icon" viewBox="0 0 24 24">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
            <line x1="1" y1="10" x2="23" y2="10"></line>
        </svg>
    </div>
</div>

<script type="module">
    import { initUser, subscribeToUser, subscribeToMarket } from './user-service.js';
    import { db } from './firebase-config.js';
    import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#000000');

    let currentMarket = [];
    let currentUserData = null;

    // --- ФОРМАТИРОВАНИЕ ---
    function formatFull(num) {
        if (!num && num !== 0) return "0";
        return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    // Добавлена функция Compact как в p2p_market
    function formatCompact(num) {
        return Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 2 }).format(num);
    }

    function formatPrice(val) {
        if(!val && val !== 0) return "0";
        return val < 0.01 ? val.toFixed(8).replace(/\.?0+$/, "") : val.toFixed(4);
    }

    function formatDate(iso) {
        const d = new Date(iso);
        return d.getDate() + ' ' + d.toLocaleString('en', {month:'short'});
    }

    function formatTime(iso) {
        const d = new Date(iso);
        return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
    }

    window.switchTab = function(tabName, el) {
        document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        ['portfolio', 'goods', 'history'].forEach(id => document.getElementById('tab-' + id).classList.add('hidden'));
        document.getElementById('tab-' + tabName).classList.remove('hidden');
    }

    async function initWallet() {
        await initUser();
        subscribeToMarket((tokens) => {
            currentMarket = tokens;
            if(currentUserData) { renderPortfolio(); renderTotalAssets(); }
        });
        subscribeToUser((user) => {
            currentUserData = user;
            renderTotalAssets();
            renderPortfolio();
            renderGoods();
            renderHistory();
        });
    }

    function renderTotalAssets() {
        if(!currentUserData) return;
        document.getElementById('totalAssetsDisplay').innerText = formatFull(currentUserData.balance || 0);
    }

    function renderPortfolio() {
        const grid = document.getElementById('portfolioGrid');
        const port = currentUserData?.portfolio || {};
        const keys = Object.keys(port).filter(k => port[k] > 0);
        grid.innerHTML = '';
        if(keys.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; color: #555; text-align: center; padding: 20px;">No assets</div>';
            return;
        }
        keys.forEach(tid => {
            const amt = port[tid];
            const tInfo = currentMarket.find(x => x.id === tid) || { name: tid, price: 0, image: null, id: tid };
            const img = tInfo.image || 'Sprites/GiftIcon.png';
            const card = document.createElement('div');
            card.className = 'crypto-card';
            card.onclick = () => location.href = `crypto_info.html?id=${tid}`;
            card.innerHTML = `
                <div class="card-icon-area"><img src="${img}" class="card-icon-img" style="border-radius:50%;"></div>
                <div class="card-info">
                    <span class="token-name">${tInfo.name}</span>
                    <div class="card-row">
                        <span class="price-tag">${formatPrice(tInfo.price)} <img src="Sprites/Blyx.png" style="width:10px; height:10px;"></span>
                        <span class="token-amount">x${formatFull(amt)}</span>
                    </div>
                </div>`;
            grid.appendChild(card);
        });
    }

    // --- ОБНОВЛЕННЫЙ RENDER GOODS (Копия стиля P2P Market) ---
    async function renderGoods() {
        const list = document.getElementById('goodsList');
        if(!currentUserData) return;
        const q = query(collection(db, "orders"), where("sellerId", "==", currentUserData.id.toString()));
        const snap = await getDocs(q);
        list.innerHTML = snap.empty ? '<div style="text-align:center;color:#666;padding:20px;">No active sell orders</div>' : "";
        
        snap.forEach(d => {
            const o = {id: d.id, ...d.data()};
            let avatarHtml = `<div class="oc-avatar" style="background:#333;"></div>`;
            if(o.sellerAvatar) avatarHtml = `<img src="${o.sellerAvatar}" class="oc-avatar-img">`;
            
            // Стиль кнопки как в p2p_market
            const actionBtn = `<button class="oc-buy-btn" style="background:#222; color:#fff; border-color:#333;" onclick="location.href='p2p_sell.html?oid=${o.id}'">Edit</button>`;

            list.insertAdjacentHTML('beforeend', `
                <div class="order-card" style="margin-bottom:12px;">
                    <div class="oc-header">
                        <div class="oc-price">${formatPrice(o.price)} <img src="Sprites/Blyx.png" style="width:16px;"></div>
                        ${actionBtn}
                    </div>
                    <div class="oc-user-row">
                        ${avatarHtml}
                        <div>
                            <div class="oc-username">${o.sellerName} (You)</div>
                            <div class="oc-stats">${o.sellerRep || 0} trades</div>
                        </div>
                    </div>
                    <div class="oc-limits-row">
                        <span>Avail: <span class="oc-val">${formatCompact(o.amount)} ${o.tokenId}</span></span>
                        <span style="display:flex; align-items:center; gap:2px;">
                            Lim: <span class="oc-val">${formatCompact(o.minLimit)}</span>
                            <img src="Sprites/Blyx.png" style="width:10px; height:10px;">
                        </span>
                    </div>
                </div>`);
        });
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        const txs = (currentUserData?.transactions || []).slice().reverse();
        list.innerHTML = txs.length === 0 ? '<div style="text-align:center;color:#666;padding:20px;">No transactions</div>' : "";
        
        txs.forEach(tx => {
            let mainIcon = 'Sprites/Cart.png'; 
            let title = 'Transaction';
            let sub = 'balance';
            
            let tokenIconUrl = 'Sprites/Blyx.png'; 
            if (tx.token && tx.token !== 'BLYX') {
                const foundToken = currentMarket.find(t => t.id === tx.token);
                tokenIconUrl = foundToken?.image || 'Sprites/GiftIcon.png';
            }

            let prefix = '';
            let finalAmt = tx.amount;

            if(tx.type === 'replenish' || tx.type === 'deposit') {
                title = 'Replenishment'; mainIcon = 'Sprites/Wallet.png'; sub = 'To balance'; prefix = '+';
            } else if(tx.type === 'transfer_in' || tx.type === 'receive') {
                title = 'Gift'; mainIcon = 'Sprites/Gift.png'; sub = `from @${tx.fromUser || 'user'}`; prefix = '+';
            } else if(tx.type === 'transfer_out' || tx.type === 'send') {
                title = 'Transfer'; mainIcon = 'Sprites/Cart.png'; sub = `to @${tx.toUser || 'user'}`; prefix = '-';
            } else if(tx.type === 'buy' || tx.type === 'p2p_buy') {
                title = 'Purchase'; mainIcon = 'Sprites/Cart.png'; sub = 'Market'; prefix = '-'; finalAmt = tx.total || tx.amount; tokenIconUrl = 'Sprites/Blyx.png';
            } else if(tx.type === 'sell' || tx.type === 'p2p_sold') {
                title = 'Sold'; mainIcon = 'Sprites/Sell.png'; sub = 'Market'; prefix = '+'; finalAmt = tx.total || tx.amount; tokenIconUrl = 'Sprites/Blyx.png';
            } else {
                prefix = tx.amount >= 0 ? '+' : '-';
            }

            const dateStr = formatDate(tx.date) + ' ' + formatTime(tx.date);

            list.insertAdjacentHTML('beforeend', `
            <div class="wh-item" style="padding:14px 0; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="background:#1c1c1c; border-radius:12px; width:44px; height:44px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                        <img src="${mainIcon}" style="width:24px; height:24px;">
                    </div>
                    <div>
                        <div style="font-weight:600; font-size:15px; color:#fff;">${title}</div>
                        <div style="font-size:12px; color:#666;">${sub}</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="display:flex; align-items:center; justify-content:flex-end; gap:6px;">
                        <span style="font-weight:700; font-size:16px; color:#fff;">
                            ${prefix}${formatFull(Math.abs(finalAmt))}
                        </span>
                        <img src="${tokenIconUrl}" style="width:18px; height:18px; border-radius:50%;">
                    </div>
                    <div style="font-size:11px; color:#444; margin-top:4px;">${dateStr}</div>
                </div>
            </div>`);
        });
    }

    initWallet();
</script>
</body>
</html>
