<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Wallet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

    <!-- Total Assets Header -->
    <div class="balance-card">
        <div class="balance-label">Total Assets</div>
        <div class="balance-val" id="totalAssetsVal">$0.00</div>
        <div style="color:#666; font-size:14px; margin-top:5px; display:flex; gap:6px;">
            <span>Balance:</span> <span id="blyxBalance" style="color:white; font-weight:700;">0</span> <img src="Sprites/Blyx.png" style="width:16px; height:16px; margin-top:1px;">
        </div>
    </div>

    <!-- Actions -->
    <div class="actions-row">
        <div class="action-btn" onclick="location.href='deposit.html'">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
            <span class="action-label">Deposit</span>
        </div>
        <div class="action-btn" onclick="location.href='transfer.html'">
            <svg class="icon" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            <span class="action-label">Send</span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-scroll" style="margin-bottom: 20px;">
        <div class="tab-link active" onclick="switchTab('portfolio', this)">Portfolio</div>
        <div class="tab-link" onclick="switchTab('goods', this)">Goods</div>
        <div class="tab-link" onclick="switchTab('history', this)">History</div>
    </div>

    <!-- CONTENT -->
    <div style="padding: 0 16px 100px;">
        
        <!-- TAB: PORTFOLIO -->
        <div id="tab-portfolio" class="content-section">
            <div class="portfolio-grid" id="portfolioGrid">
                <div style="color: #666; font-size: 14px; grid-column: 1/-1; text-align: center;">Loading...</div>
            </div>
        </div>

        <!-- TAB: GOODS (Selling) -->
        <div id="tab-goods" class="content-section hidden">
            <div id="itemsList" class="market-list">
                <div style="color: #666; font-size: 14px; text-align: center;">No active sell orders</div>
            </div>
        </div>

        <!-- TAB: HISTORY -->
        <div id="tab-history" class="content-section hidden">
            <div id="historyList">
                <div style="color: #666; font-size: 14px; text-align: center;">No transactions</div>
            </div>
        </div>

    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="location.href='index.html'"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></div>
        <div class="nav-item" onclick="location.href='markets.html'"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></div>
        <div class="nav-trade-circle" onclick="location.href='markets.html'"><svg class="icon" style="color:black;" viewBox="0 0 24 24"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg></div>
        <div class="nav-item" onclick="location.href='transfer.html'"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div>
        <div class="nav-item active"><svg class="icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg></div>
    </div>

    <script type="module">
        import { initUser, subscribeToUser, subscribeToMarket } from './user-service.js';
        import { db } from './firebase-config.js';
        import { collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');

        let currentMarket = []; 
        let currentUserData = null;

        // FORMATTERS
        function formatPrice(val) {
            if(!val || val === 0) return "0";
            return val < 0.01 ? val.toFixed(8).replace(/\.?0+$/, "") : val.toFixed(2);
        }
        function formatCompact(num) {
            if (!num) return "0";
            return Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 2 }).format(num);
        }
        function formatDate(iso) {
            const d = new Date(iso);
            return d.getDate() + ' ' + d.toLocaleString('en', {month:'short'}) + ' ' + d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
        }

        // TABS
        window.switchTab = function(tabName, el) {
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            ['portfolio', 'goods', 'history'].forEach(id => document.getElementById('tab-' + id).classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
        }

        async function initWallet() {
            await initUser();

            // 1. Market Data
            subscribeToMarket((tokens) => {
                currentMarket = tokens;
                if(currentUserData) {
                    renderPortfolio();
                    renderTotalAssets();
                }
            });

            // 2. User Data
            subscribeToUser((user) => {
                currentUserData = user;
                renderPortfolio();
                renderTotalAssets();
                renderHistory();
                renderGoods();
            });
        }

        function renderTotalAssets() {
            if(!currentUserData) return;
            let totalBlyx = currentUserData.balance || 0;
            let totalValue = totalBlyx; // Assuming 1 BLYX = $1 for simplicity or base calculation
            
            // Add Token Values
            const port = currentUserData.portfolio || {};
            for(let t in port) {
                const amount = port[t];
                const tokenData = currentMarket.find(x => x.id === t);
                if(tokenData && amount > 0) {
                    // Total Value in BLYX
                    totalValue += amount * tokenData.price;
                }
            }
            
            // Render Total
            // Assuming we display value in BLYX or similar equivalent
            document.getElementById('totalAssetsVal').innerText = "≈ " + formatCompact(totalValue); 
            document.getElementById('blyxBalance').innerText = formatCompact(totalBlyx);
        }

        function renderPortfolio() {
            const grid = document.getElementById('portfolioGrid');
            const port = currentUserData.portfolio || {};
            const keys = Object.keys(port);
            grid.innerHTML = '';

            const validKeys = keys.filter(k => port[k] > 0);

            if(validKeys.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">No assets</div>';
                return;
            }

            validKeys.forEach(tid => {
                const amt = port[tid];
                const tInfo = currentMarket.find(x => x.id === tid) || { name: tid, price: 0, image: null, id: tid };
                
                let iconHtml = tInfo.image ? `<img src="${tInfo.image}" class="card-icon-img">` : `<div class="token-icon-fallback">${tInfo.id[0]}</div>`;

                const card = document.createElement('div');
                card.className = 'crypto-card';
                card.onclick = () => location.href = `crypto_info.html?id=${tid}`;
                card.innerHTML = `
                    <div class="card-icon-area">${iconHtml}</div>
                    <div class="card-info">
                        <span class="token-name">${tInfo.name}</span>
                        <div class="card-row">
                            <span class="price-tag">${formatPrice(tInfo.price)}</span>
                            <span class="token-amount">${formatCompact(amt)}</span>
                        </div>
                    </div>`;
                grid.appendChild(card);
            });
        }

        async function renderGoods() {
            const list = document.getElementById('itemsList');
            if(!currentUserData) return;

            const q = query(collection(db, "orders"), where("sellerId", "==", currentUserData.id.toString()));
            const snap = await getDocs(q);
            
            list.innerHTML = "";
            if(snap.empty) {
                list.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">No active sell orders</div>';
                return;
            }

            snap.forEach(d => {
                const o = d.data();
                const item = document.createElement('div');
                item.className = 'goods-item';
                item.innerHTML = `
                    <div class="gi-title">Selling ${formatCompact(o.amount)} ${o.tokenId}</div>
                    <div class="gi-price">${o.price} BLYX</div>`;
                list.appendChild(item);
            });
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const txs = (currentUserData.transactions || []).reverse();
            list.innerHTML = "";

            if(txs.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">No transactions</div>';
                return;
            }

            txs.forEach(tx => {
                // DEFAULT VARS
                let icon = 'Sprites/Purchase.png'; 
                let title = 'Transaction';
                let sub = 'balance';
                let amountHtml = `<span style="color:white;">${formatCompact(tx.amount)}</span>`;
                
                // LOGIC MAPPING
                if(tx.type === 'replenish' || tx.type === 'deposit') {
                    // Пополнение баланса
                    title = 'Replenishment';
                    icon = 'Sprites/Replenishment.png';
                    sub = 'balance';
                    amountHtml = `<span style="color:#FFF;">+${formatCompact(tx.amount)}</span> <img src="Sprites/Blyx.png" class="wh-coin-icon">`;
                }
                else if(tx.type === 'transfer_in' || tx.type === 'receive') {
                    // Получение перевода
                    title = 'Transfer';
                    icon = 'Sprites/Transfer.png';
                    sub = `from @${tx.fromUser || tx.from || 'user'}`;
                    amountHtml = `<span style="color:#FFF;">+${formatCompact(tx.amount)}</span> <img src="Sprites/Blyx.png" class="wh-coin-icon">`;
                }
                else if(tx.type === 'transfer_out' || tx.type === 'send') {
                    // Отправка перевода
                    title = 'Transfer';
                    icon = 'Sprites/Transfer.png'; // Можно использовать повернутую или ту же
                    sub = `to @${tx.toUser || tx.to || 'user'}`;
                    amountHtml = `<span style="color:#FFF;">-${formatCompact(tx.amount)}</span> <img src="Sprites/Blyx.png" class="wh-coin-icon">`;
                }
                else if(tx.type === 'buy') {
                    // Покупка крипты (Spending BLYX -> Gaining Token)
                    title = 'Purchase';
                    icon = 'Sprites/Purchase.png';
                    sub = 'balance';
                    // Справа показываем сколько крипты получили
                    // tx.token - имя токена (BTC)
                    // Иконку крипты можно найти в currentMarket по имени
                    const tData = currentMarket.find(x => x.id === tx.token);
                    const tIcon = tData && tData.image ? `<img src="${tData.image}" class="wh-coin-icon" style="border-radius:50%;">` : `<div class="wh-coin-icon" style="background:#444;border-radius:50%;font-size:8px;display:flex;align-items:center;justify-content:center;">${tx.token?tx.token[0]:'?'}</div>`;

                    amountHtml = `<span style="color:#FFF;">+${formatCompact(tx.amount)} ${tx.token}</span> ${tIcon}`;
                }
                else if(tx.type === 'sell') {
                    // Продажа крипты (Selling Token -> Gaining BLYX)
                    title = 'Sale';
                    icon = 'Sprites/Replenishment.png'; // Получаем деньги
                    sub = 'portfolio';
                    // Показываем сколько BLYX получили
                    let totalVal = tx.total || (tx.amount * tx.price);
                    amountHtml = `<span style="color:#CCFF00;">+${formatCompact(totalVal)}</span> <img src="Sprites/Blyx.png" class="wh-coin-icon">`;
                }

                const html = `
                <div class="wh-item">
                    <div class="wh-left">
                        <div class="wh-icon-bg"><img src="${icon}" class="wh-icon-img" onerror="this.src='Sprites/Blyx.png'"></div>
                        <div class="wh-info">
                            <div class="wh-title">${title}</div>
                            <div class="wh-sub">${sub}</div>
                        </div>
                    </div>
                    <div class="wh-right">
                        <div class="wh-amount">${amountHtml}</div>
                        <div class="wh-date">${formatDate(tx.date)}</div>
                    </div>
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        initWallet();
    </script>
</body>
</html>
