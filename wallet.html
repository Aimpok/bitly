<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wallet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<!-- Balance Card -->
<div class="balance-card">
    <div class="balance-label">Total Balance</div>
    <div class="balance-val" style="display: flex; align-items: center; gap: 8px;">
        <span id="mainBalance">0</span>
        <img src="Sprites/Blyx.png" style="width: 32px; height: 32px; object-fit: contain; margin-top: 4px;" alt="Blyx">
    </div>
</div>

<!-- Actions -->
<div class="actions-row">
    <div class="action-btn" onclick="location.href='deposit.html'">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
        <span class="action-label">Deposit</span>
    </div>
    <div class="action-btn" onclick="location.href='transfer.html'">
        <svg class="icon" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        <span class="action-label">Send</span>
    </div>
</div>

<!-- Portfolio -->
<div class="portfolio-section">
    <h3 class="portfolio-title">Portfolio</h3>
    
    <div class="portfolio-grid" id="portfolioGrid">
        <!-- Сюда скрипт вставит карточки -->
        <div style="color: #666; font-size: 14px;">Loading...</div>
    </div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
    <div class="nav-item" onclick="location.href='index.html'">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </div>
    <div class="nav-item" onclick="location.href='markets.html'">
        <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
    </div>
    <div class="nav-trade-circle" onclick="location.href='markets.html'">
        <svg class="icon" style="color:black;" viewBox="0 0 24 24"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
    </div>
    <div class="nav-item">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
    </div>
    <div class="nav-item active">
        <svg class="icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
    </div>
</div>

<script type="module">
    import { initUser, subscribeToUser, subscribeToMarket } from './user-service.js';

    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#000000');

    let currentMarket = []; // Храним цены, чтобы считать стоимость портфеля

    async function initWallet() {
        await initUser();

        // 1. Подписываемся на цены рынка (чтобы знать актуальную цену в портфеле)
        subscribeToMarket((tokens) => {
            currentMarket = tokens;
            // Если юзер уже загружен, перерисовываем портфель с новыми ценами
            const userData = window.currentUserData; 
            if(userData) renderPortfolio(userData);
        });

        // 2. Подписываемся на данные юзера
        subscribeToUser((user) => {
            window.currentUserData = user; // Сохраняем глобально для доступа внутри функции рынка
            
            // Обновляем общий баланс BLYX
            const balance = user.balance !== undefined ? user.balance : 0;
            document.getElementById('mainBalance').innerText = Math.floor(balance).toLocaleString();

            renderPortfolio(user);
        });
    }

    function renderPortfolio(user) {
        const grid = document.getElementById('portfolioGrid');
        if(!grid) return;

        const portfolio = user.portfolio || {};
        const keys = Object.keys(portfolio);

        grid.innerHTML = '';

        if(keys.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; color: #555; text-align: center; padding: 20px;">No assets yet</div>';
            return;
        }

        keys.forEach(tokenId => {
            const amount = portfolio[tokenId]; // Количество монет у юзера
            if(amount <= 0) return; // Не показываем нулевые балансы

            // Ищем инфу о токене в рыночных данных
            const tokenInfo = currentMarket.find(t => t.id === tokenId) || { 
                name: tokenId, 
                price: 0, 
                image: null,
                id: tokenId
            };

            // ФОРМАТИРОВАНИЕ ЦЕНЫ (Исправлено)
            // Если цена меньше 0.01, показываем 6 знаков, иначе 2 знака
            const displayPrice = parseFloat(tokenInfo.price) < 0.01 
                ? parseFloat(tokenInfo.price).toFixed(6) 
                : parseFloat(tokenInfo.price).toFixed(2);

            // ЛОГИКА ИКОНКИ (Исправлено)
            // Если нет картинки -> показываем букву
            let iconHtml;
            if (tokenInfo.image) {
                iconHtml = `<img src="${tokenInfo.image}" class="card-icon-img" alt="${tokenId}">`;
            } else {
                iconHtml = `<div class="token-icon-fallback">${tokenInfo.id[0]}</div>`;
            }

            const card = document.createElement('div');
            card.className = 'crypto-card';
            card.onclick = () => location.href = `crypto_info.html?id=${tokenId}`;
            
            card.innerHTML = `
                <div class="card-icon-area">
                    ${iconHtml}
                </div>
                <div class="card-info">
                    <span class="token-name">${tokenInfo.name}</span>
                    <div class="card-row">
                        <span class="price-tag">
                            ${displayPrice}
                            <img src="Sprites/Blyx.png" style="width: 10px; height: 10px; object-fit: contain;">
                        </span>
                        <span class="token-amount">x${Math.floor(amount).toLocaleString()}</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    initWallet();
</script>
</body>
</html>
