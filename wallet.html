<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wallet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

    <!-- Total Assets Header -->
    <div style="padding: 20px 16px 10px;">
        <div style="font-size: 13px; color: #888; margin-bottom: 4px;">Total Assets</div>
        <div style="font-size: 36px; font-weight: 800; color: white;" id="totalAssetsVal">$0.00</div>
    </div>

    <!-- Actions -->
    <div class="actions-row">
        <div class="action-btn" onclick="location.href='deposit.html'">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
            <span class="action-label">Deposit</span>
        </div>
        <div class="action-btn" onclick="location.href='transfer.html'">
            <svg class="icon" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            <span class="action-label">Send</span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="wallet-tabs">
        <div class="wt-link active" onclick="switchTab('portfolio', this)">Portfolio</div>
        <div class="wt-link" onclick="switchTab('items', this)">Items</div>
        <div class="wt-link" onclick="switchTab('history', this)">History</div>
    </div>

    <!-- CONTENT -->
    <div style="padding: 0 16px 100px;">
        
        <!-- TAB: PORTFOLIO -->
        <div id="tab-portfolio">
            <div class="portfolio-grid" id="portfolioGrid">
                <div style="color: #666; font-size: 14px;">Loading...</div>
            </div>
        </div>

        <!-- TAB: ITEMS (P2P Orders) -->
        <div id="tab-items" class="hidden">
            <div id="itemsList" class="market-list">
                <div style="color: #666; font-size: 14px; text-align: center;">No active sell orders</div>
            </div>
        </div>

        <!-- TAB: HISTORY -->
        <div id="tab-history" class="hidden">
            <div id="historyList">
                <div style="color: #666; font-size: 14px; text-align: center;">No transactions</div>
            </div>
        </div>

    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="location.href='index.html'"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></div>
        <div class="nav-item" onclick="location.href='markets.html'"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></div>
        <div class="nav-trade-circle" onclick="location.href='markets.html'"><svg class="icon" style="color:black;" viewBox="0 0 24 24"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg></div>
        <div class="nav-item" onclick="location.href='transfer.html'"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div>
        <div class="nav-item active"><svg class="icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg></div>
    </div>

    <script type="module">
        import { initUser, subscribeToUser, subscribeToMarket } from './user-service.js';
        import { db } from './firebase-config.js';
        import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');

        let currentMarket = []; 
        let currentUserData = null;

        // FORMATTERS
        function formatPrice(val) {
            if(!val || val === 0) return "0";
            return val < 0.01 ? val.toFixed(8).replace(/\.?0+$/, "") : val.toFixed(2);
        }
        function formatCompact(num) {
            if (!num) return "0";
            return Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 2 }).format(num);
        }

        // TABS
        window.switchTab = function(tabName, el) {
            document.querySelectorAll('.wt-link').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            ['portfolio', 'items', 'history'].forEach(id => document.getElementById('tab-' + id).classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
        }

        async function initWallet() {
            await initUser();

            // 1. Market Data
            subscribeToMarket((tokens) => {
                currentMarket = tokens;
                if(currentUserData) {
                    renderPortfolio();
                    renderTotalAssets();
                }
            });

            // 2. User Data
            subscribeToUser((user) => {
                currentUserData = user;
                renderPortfolio();
                renderTotalAssets();
                renderHistory();
                loadMyOrders();
            });
        }

        function renderTotalAssets() {
            if(!currentUserData) return;
            let total = currentUserData.balance || 0;
            
            // Add Token Values
            const port = currentUserData.portfolio || {};
            for(let t in port) {
                const amount = port[t];
                const tokenData = currentMarket.find(x => x.id === t);
                if(tokenData && amount > 0) {
                    total += amount * tokenData.price;
                }
            }
            // Формат $14.25k
            document.getElementById('totalAssetsVal').innerText = "$" + formatCompact(total);
        }

        function renderPortfolio() {
            const grid = document.getElementById('portfolioGrid');
            const port = currentUserData.portfolio || {};
            const keys = Object.keys(port);
            grid.innerHTML = '';

            if(keys.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#666;">No assets</div>';
                return;
            }

            keys.forEach(tid => {
                const amt = port[tid];
                if(amt <= 0) return;
                
                const tInfo = currentMarket.find(x => x.id === tid) || { name: tid, price: 0, image: null, id: tid };
                
                let iconHtml = tInfo.image ? `<img src="${tInfo.image}" class="card-icon-img">` : `<div class="token-icon-fallback">${tInfo.id[0]}</div>`;

                const card = document.createElement('div');
                card.className = 'crypto-card';
                card.onclick = () => location.href = `crypto_info.html?id=${tid}`;
                card.innerHTML = `
                    <div class="card-icon-area">${iconHtml}</div>
                    <div class="card-info">
                        <span class="token-name">${tInfo.name}</span>
                        <div class="card-row">
                            <span class="price-tag">${formatPrice(tInfo.price)} <img src="Sprites/Blyx.png" style="width:10px;"></span>
                            <span class="token-amount">x${formatCompact(amt)}</span>
                        </div>
                    </div>`;
                grid.appendChild(card);
            });
        }

        async function loadMyOrders() {
            const list = document.getElementById('itemsList');
            // Fetch my orders from 'orders' collection
            const q = query(collection(db, "orders"), where("sellerId", "==", currentUserData.id.toString()));
            const snap = await getDocs(q);
            
            list.innerHTML = "";
            if(snap.empty) {
                list.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">No active orders</div>';
                return;
            }

            snap.forEach(d => {
                const o = d.data();
                const item = document.createElement('div');
                item.className = 'market-item';
                item.innerHTML = `
                    <div class="market-left">
                        <div class="coin-avatar" style="background:#333;"><span class="coin-letter">S</span></div>
                        <div class="market-info"><div class="market-pair">Sell ${o.tokenId}</div><div class="t-sub">${formatCompact(o.amount)} left</div></div>
                    </div>
                    <div class="market-right">
                        <div class="market-price-row">${formatPrice(o.price)} <img src="Sprites/Blyx.png" style="width:14px;"></div>
                    </div>`;
                list.appendChild(item);
            });
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const txs = (currentUserData.transactions || []).reverse();
            list.innerHTML = "";

            if(txs.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">No transactions</div>';
                return;
            }

            txs.forEach(tx => {
                let icon = 'Sprites/Blyx.png'; 
                let title = 'Transaction';
                let sub = new Date(tx.date).toLocaleDateString();
                let amountStr = '';
                let colorClass = 'white';
                
                // Logic based on types
                if(tx.type === 'deposit') {
                    title = 'Replenishment';
                    icon = 'Sprites/Replenishment.png';
                    amountStr = `+${formatCompact(tx.amount)} <img src="Sprites/Blyx.png" style="width:14px; margin-left:4px;">`;
                    colorClass = 'var(--accent-green)';
                } 
                else if(tx.type === 'send') {
                    title = 'Transfer';
                    icon = 'Sprites/Transfer.png';
                    sub = `to @${tx.to || 'user'}`;
                    amountStr = `-${formatCompact(tx.amount)} <img src="Sprites/Blyx.png" style="width:14px; margin-left:4px;">`;
                    colorClass = 'var(--accent-red)';
                }
                else if(tx.type === 'receive') {
                    title = 'Transfer';
                    icon = 'Sprites/Transfer.png';
                    sub = `from @${tx.from || 'user'}`;
                    amountStr = `+${formatCompact(tx.amount)} <img src="Sprites/Blyx.png" style="width:14px; margin-left:4px;">`;
                    colorClass = 'var(--accent-green)';
                }
                else if(tx.type === 'buy' || tx.type === 'p2p_buy') {
                    title = `Bought ${tx.token}`;
                    icon = 'Sprites/Purchase.png'; // Или иконка токена, если есть
                    amountStr = `+${formatCompact(tx.amount)} ${tx.token}`;
                    colorClass = 'var(--accent-green)';
                }
                else if(tx.type === 'sell' || tx.type === 'p2p_sold') {
                    title = `Sold ${tx.token}`;
                    icon = 'Sprites/Purchase.png';
                    amountStr = `+${formatCompact(tx.amount * tx.price)} <img src="Sprites/Blyx.png" style="width:14px; margin-left:4px;">`;
                    colorClass = 'var(--accent-green)';
                }
                else if(tx.type === 'create_buy') {
                    title = `Launched ${tx.token}`;
                    icon = 'Sprites/Purchase.png';
                    amountStr = `+${formatCompact(tx.amount)} ${tx.token}`;
                    colorClass = 'var(--accent-green)';
                }

                const html = `
                <div class="wh-item">
                    <div class="wh-left">
                        <div class="wh-icon-bg"><img src="${icon}" class="wh-icon-img" onerror="this.src='Sprites/Blyx.png'"></div>
                        <div class="wh-info">
                            <div class="wh-title">${title}</div>
                            <div class="wh-sub">${sub}</div>
                        </div>
                    </div>
                    <div class="wh-right">
                        <div class="wh-amount" style="color:${colorClass}">${amountStr}</div>
                        <div class="wh-date">${new Date(tx.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                    </div>
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        initWallet();
    </script>
</body>
</html>
