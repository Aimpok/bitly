<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wallet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .wh-amount { color: #FFFFFF !important; }
        .wh-coin-icon { width: 16px; height: 16px; object-fit: contain; vertical-align: middle; margin-left: 4px; border-radius: 50%; }
        
        /* Убираем линию под вкладками */
        .tabs-scroll { margin-bottom: 20px; border-bottom: none !important; }
        
        .hidden { display: none !important; }
        /* Убираем границы у элементов истории */
        .wh-item { border: none !important; }
    </style>
</head>
<body>

    <!-- Total Assets Header (Теперь только чистый баланс Blyx) -->
    <div class="balance-card">
        <div class="balance-label">Total Assets</div>
        <div class="balance-val" style="display: flex; align-items: center; gap: 8px;">
            <span id="totalAssetsDisplay">0</span>
            <img src="Sprites/Blyx.png" style="width: 32px; height: 32px; object-fit: contain; margin-top: 4px;" alt="Blyx">
        </div>
    </div>

    <!-- Actions -->
    <div class="actions-row">
        <div class="action-btn" onclick="location.href='deposit.html'">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
            <span class="action-label">Deposit</span>
        </div>
        <div class="action-btn" onclick="location.href='transfer.html'">
            <svg class="icon" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            <span class="action-label">Send</span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-scroll">
        <div class="tab-link active" onclick="switchTab('portfolio', this)">Portfolio</div>
        <div class="tab-link" onclick="switchTab('goods', this)">Goods</div>
        <div class="tab-link" onclick="switchTab('history', this)">History</div>
    </div>

    <!-- CONTENT -->
    <div style="padding: 0 16px 100px;">

        <!-- 1. PORTFOLIO -->
        <div id="tab-portfolio">
            <div class="portfolio-grid" id="portfolioGrid">
                <div style="color: #666; font-size: 14px; text-align:center; grid-column:1/-1;">Loading...</div>
            </div>
        </div>

        <!-- 2. GOODS (MY ORDERS) -->
        <div id="tab-goods" class="hidden">
            <div id="goodsList" style="display:flex; flex-direction:column;">
                <div style="color: #666; font-size: 14px; text-align: center;">No active sell orders</div>
            </div>
        </div>

        <!-- 3. HISTORY -->
        <div id="tab-history" class="hidden">
            <div id="historyList">
                <div style="color: #666; font-size: 14px; text-align: center;">No transactions</div>
            </div>
        </div>

    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="location.href='index.html'"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></div>
        <div class="nav-item" onclick="location.href='markets.html'"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></div>
        <div class="nav-trade-circle" onclick="location.href='markets.html'"><svg class="icon" style="color:black;" viewBox="0 0 24 24"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg></div>
        <div class="nav-item" onclick="location.href='transfer.html'"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div>
        <div class="nav-item active"><svg class="icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg></div>
    </div>

    <script type="module">
        import { initUser, subscribeToUser, subscribeToMarket } from './user-service.js';
        import { db } from './firebase-config.js';
        import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');

        let currentMarket = [];
        let currentUserData = null;

        // UTILS
        // Функция для полного отображения баланса без сокращений типа "1k"
        function formatFull(num) {
            if (!num && num !== 0) return "0";
            return num.toLocaleString('en-US', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 2 
            });
        }

        // Оставляем compact для маленьких подписей в карточках, где мало места
        function formatCompact(num) {
            if (!num && num !== 0) return "0";
            return Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 2 }).format(num);
        }

        function formatPrice(val) {
            if(!val && val !== 0) return "0";
            return val < 0.01 ? val.toFixed(8).replace(/\.?0+$/, "") : val.toFixed(4);
        }

        function formatDate(iso) {
            const d = new Date(iso);
            return d.getDate() + ' ' + d.toLocaleString('en', {month:'short'});
        }

        function formatTime(iso) {
            const d = new Date(iso);
            return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
        }

        window.switchTab = function(tabName, el) {
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            ['portfolio', 'goods', 'history'].forEach(id => document.getElementById('tab-' + id).classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
        }

        async function initWallet() {
            await initUser();
            subscribeToMarket((tokens) => {
                currentMarket = tokens;
                if(currentUserData) renderPortfolio(); 
                if(currentUserData) renderTotalAssets();
            });
            subscribeToUser((user) => {
                currentUserData = user;
                renderTotalAssets();
                renderPortfolio();
                renderGoods();
                renderHistory();
            });
        }

        function renderTotalAssets() {
            if(!currentUserData) return;
            // Теперь берем ТОЛЬКО чистый баланс Blyx, не прибавляя токены
            let total = currentUserData.balance || 0;
            document.getElementById('totalAssetsDisplay').innerText = formatFull(total);
        }

        function renderPortfolio() {
            const grid = document.getElementById('portfolioGrid');
            const port = currentUserData.portfolio || {};
            const keys = Object.keys(port).filter(k => port[k] > 0);

            grid.innerHTML = '';
            if(keys.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; color: #555; text-align: center; padding: 20px;">No assets</div>';
                return;
            }

            keys.forEach(tid => {
                const amt = port[tid];
                const tInfo = currentMarket.find(x => x.id === tid) || { name: tid, price: 0, image: null, id: tid };
                const img = tInfo.image || 'Sprites/GiftIcon.png';

                const card = document.createElement('div');
                card.className = 'crypto-card';
                card.onclick = () => location.href = `crypto_info.html?id=${tid}`;
                card.innerHTML = `
                    <div class="card-icon-area">
                        <img src="${img}" class="card-icon-img" style="border-radius:50%;">
                    </div>
                    <div class="card-info">
                        <span class="token-name">${tInfo.name}</span>
                        <div class="card-row">
                            <span class="price-tag">${formatPrice(tInfo.price)} <img src="Sprites/Blyx.png" style="width:10px; height:10px; margin-left:2px;"></span>
                            <span class="token-amount">x${formatFull(amt)}</span>
                        </div>
                    </div>`;
                grid.appendChild(card);
            });
        }

        async function renderGoods() {
            const list = document.getElementById('goodsList');
            if(!currentUserData) return;
            const q = query(collection(db, "orders"), where("sellerId", "==", currentUserData.id.toString()));
            const snap = await getDocs(q);
            list.innerHTML = "";
            if(snap.empty) {
                list.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">No active sell orders</div>';
                return;
            }
            snap.forEach(d => {
                const o = {id: d.id, ...d.data()};
                let avatarHtml = `<div class="oc-avatar" style="background:#333;"></div>`;
                if(o.sellerAvatar) avatarHtml = `<img src="${o.sellerAvatar}" class="oc-avatar-img">`;

                const item = document.createElement('div');
                item.className = 'order-card';
                item.innerHTML = `
                    <div class="oc-header">
                        <div class="oc-price">${formatFull(o.price)} <img src="Sprites/Blyx.png" style="width:16px;"></div>
                        <button class="oc-buy-btn" style="background:#333; color:#fff;" onclick="location.href='p2p_sell.html?oid=${o.id}'">Edit</button>
                    </div>
                    <div class="oc-user-row">
                        ${avatarHtml}
                        <div>
                            <div class="oc-username">${o.sellerName} (Me)</div>
                            <div class="oc-stats">${o.sellerRep || 0} trades, 100%</div>
                        </div>
                    </div>
                    <div class="oc-limits-row">
                        <span>Avail: <span class="oc-val">${formatFull(o.amount)} ${o.tokenId}</span></span>
                        <span style="display:flex; align-items:center; gap:2px;">
                            Lim: <span class="oc-val">${formatFull(o.minLimit)}</span>
                            <img src="Sprites/Blyx.png" style="width:10px; height:10px;">
                        </span>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const txs = (currentUserData.transactions || []).reverse();
            list.innerHTML = "";

            if(txs.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">No transactions</div>';
                return;
            }

            txs.forEach(tx => {
                let icon = 'Sprites/Cart.png'; 
                let title = 'Transaction';
                let sub = 'balance';
                let amountHtml = '';

                if(tx.type === 'replenish' || tx.type === 'deposit') {
                    title = 'Replenishment';
                    icon = 'Sprites/Wallet.png'; 
                    sub = 'balance';
                    amountHtml = `+${formatFull(tx.amount)} <img src="Sprites/Blyx.png" class="wh-coin-icon">`;
                }
                else if(tx.type === 'transfer_in' || tx.type === 'receive') {
                    title = 'Gift';
                    icon = 'Sprites/Gift.png';
                    sub = `from @${tx.fromUser || 'user'}`;
                    if(tx.token && tx.token !== 'BLYX') {
                         const tInfo = currentMarket.find(x => x.id === tx.token);
                         const imgUrl = tInfo ? tInfo.image : '';
                         amountHtml = `+${formatFull(tx.amount)} ${tx.token} ${imgUrl ? `<img src="${imgUrl}" class="wh-coin-icon">` : ''}`;
                    } else {
                         amountHtml = `+${formatFull(tx.amount)} <img src="Sprites/Blyx.png" class="wh-coin-icon">`;
                    }
                }
                else if(tx.type === 'transfer_out' || tx.type === 'send') {
                    title = 'Transfer';
                    icon = 'Sprites/Cart.png';
                    sub = `to @${tx.toUser || 'user'}`;
                    if(tx.token && tx.token !== 'BLYX') {
                         amountHtml = `-${formatFull(tx.amount)} ${tx.token}`; 
                    } else {
                         amountHtml = `-${formatFull(tx.amount)} <img src="Sprites/Blyx.png" class="wh-coin-icon">`;
                    }
                }
                else if(tx.type === 'buy' || tx.type === 'p2p_buy') {
                    title = 'Purchase';
                    icon = 'Sprites/Cart.png';
                    sub = 'balance';
                    let spent = tx.total || tx.cost || (tx.amount * tx.price) || 0;
                    amountHtml = `-${formatFull(spent)} <img src="Sprites/Blyx.png" class="wh-coin-icon">`;
                }
                else if(tx.type === 'sell' || tx.type === 'p2p_sold') {
                    title = 'Sold'; 
                    icon = 'Sprites/Sell.png'; 
                    sub = 'portfolio';
                    let earned = tx.total || (tx.amount * tx.price) || 0;
                    amountHtml = `+${formatFull(earned)} <img src="Sprites/Blyx.png" class="wh-coin-icon">`;
                }
                else if(tx.type === 'cancel_order') {
                    title = 'Order Cancelled';
                    icon = 'Sprites/Wallet.png'; 
                    sub = 'Refund';
                    amountHtml = `+${formatFull(tx.amount)} ${tx.token}`;
                }
                else {
                    amountHtml = `${formatFull(tx.amount)}`;
                }

                const dateStr = formatDate(tx.date) + ' ' + formatTime(tx.date);

                const html = `
                <div class="wh-item" style="background:transparent; padding:12px 0;">
                    <div class="wh-left">
                        <div class="wh-icon-bg" style="background:#1c1c1c; border-radius:12px; width:42px; height:42px;">
                            <img src="${icon}" class="wh-icon-img" style="width:24px; height:24px;">
                        </div>
                        <div class="wh-info">
                            <div class="wh-title" style="font-size:16px;">${title}</div>
                            <div class="wh-sub">${sub}</div>
                        </div>
                    </div>
                    <div class="wh-right">
                        <div class="wh-amount" style="font-size:16px; font-weight:700;">${amountHtml}</div>
                        <div class="wh-date">${dateStr}</div>
                    </div>
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        initWallet();
    </script>
</body>
</html>
