<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Transfer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="header-nav">
        <button class="back-btn" onclick="window.history.back()">
            <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <div class="header-title">Transfer</div>
    </div>

    <div style="padding: 0 16px;">
        <!-- Amount Input -->
        <div class="input-wrapper">
            <input type="number" id="amountInput" placeholder="Amount" oninput="updateButton()">
            <div class="input-suffix">
                <span>BLYX</span>
                <img src="Sprites/Blyx.png" class="star-icon-small" alt="blyx">
            </div>
        </div>
        
        <!-- Подсказка про комиссию -->
        <div style="font-size: 12px; color: #666; margin-top: -8px; margin-bottom: 12px; margin-left: 10px;">
            Fee: 5%
        </div>

        <!-- Username Input with Avatar -->
        <div class="input-wrapper input-with-avatar" id="userWrapper">
            <img id="receiverAvatar" src="" class="avatar-preview">
            <input type="text" id="usernameInput" placeholder="@username" oninput="handleUsernameInput(this)" autocomplete="off">
            
            <div id="searchLoader" style="display:none; color: #888; font-size: 12px; margin-right: 10px;">
                ...
            </div>
        </div>
        
        <!-- Info Text (Ошибки) -->
        <div id="receiverInfo" style="font-size: 12px; color: #FF3B30; margin-top: -8px; margin-bottom: 15px; margin-left: 10px; min-height: 14px;"></div>
    </div>

    <div class="bottom-cost-panel">
        <div class="cost-label">Total Cost (inc. 5% fee)</div>
        <button class="btn-white-large btn-disabled" id="sendBtn" onclick="doTransfer()">
            <span id="btnAmount">0</span>
            <img src="Sprites/Blyx.png" class="star-icon-small" alt="blyx">
        </button>
    </div>

    <script type="module">
        import { initUser, getUserRef } from './user-service.js';
        import { db } from './firebase-config.js';
        import { collection, query, where, getDocs, runTransaction, doc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');

        let currentUser = null;
        let receiverData = null;
        let searchTimer = null;
        const FEE_PERCENT = 0.05; // 5%

        async function init() {
            currentUser = await initUser();
        }
        init();

        window.updateButton = function() {
            const inputVal = parseFloat(document.getElementById('amountInput').value);
            const btn = document.getElementById('sendBtn');
            
            if (inputVal && inputVal > 0) {
                const totalCost = inputVal * (1 + FEE_PERCENT); 
                document.getElementById('btnAmount').innerText = parseFloat(totalCost.toFixed(2));
                
                if (receiverData) btn.classList.remove('btn-disabled');
                else btn.classList.add('btn-disabled');
            } else {
                document.getElementById('btnAmount').innerText = "0";
                btn.classList.add('btn-disabled');
            }
        }

        window.handleUsernameInput = function(el) {
            clearTimeout(searchTimer);
            const rawVal = el.value.trim();
            // Убираем @ и переводим в нижний регистр для поиска
            let usernameLower = rawVal.replace('@', '').toLowerCase(); 
            
            // Сброс
            receiverData = null;
            document.getElementById('receiverAvatar').classList.remove('avatar-visible');
            document.getElementById('receiverInfo').innerText = ""; 
            updateButton();

            if(usernameLower.length < 3) return;

            document.getElementById('searchLoader').style.display = 'block';
            
            // Ищем с задержкой 500мс
            searchTimer = setTimeout(() => searchUser(usernameLower), 500);
        }

        async function searchUser(usernameLower) {
            try {
                // Ищем по username_lower, который мы добавили в user-service
                const q = query(collection(db, "users"), where("username_lower", "==", usernameLower));
                const querySnapshot = await getDocs(q);

                document.getElementById('searchLoader').style.display = 'none';

                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const data = userDoc.data();

                    if(data.id.toString() === currentUser.id.toString()) {
                        document.getElementById('receiverInfo').innerText = "Cannot send to yourself";
                        return;
                    }

                    receiverData = { ...data, docId: userDoc.id };
                    
                    const avatarEl = document.getElementById('receiverAvatar');
                    // Если есть фото - ставим, иначе заглушка
                    avatarEl.src = data.photoUrl && data.photoUrl.length > 5 ? data.photoUrl : 'Sprites/GiftIcon.png'; 
                    avatarEl.classList.add('avatar-visible');

                    document.getElementById('receiverInfo').innerText = ""; 
                    updateButton();
                } else {
                    document.getElementById('receiverInfo').innerText = "User not found";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('searchLoader').style.display = 'none';
                document.getElementById('receiverInfo').innerText = "Error searching user";
            }
        }

        window.doTransfer = async function() {
            const amount = parseFloat(document.getElementById('amountInput').value);
            
            if(!amount || amount <= 0) return;
            if(!receiverData) return;

            const totalDeduction = amount * (1 + FEE_PERCENT); 

            if(totalDeduction > currentUser.balance) { 
                tg.showAlert(`Insufficient funds! You need ${totalDeduction.toFixed(2)} BLYX`); 
                return; 
            }

            tg.showConfirm(`Send ${amount} BLYX to @${receiverData.username}?\nTotal cost: ${totalDeduction.toFixed(2)} BLYX (5% fee)`, async (ok) => {
                if(ok) {
                    try {
                        const senderRef = getUserRef();
                        const receiverRef = doc(db, "users", receiverData.docId);

                        await runTransaction(db, async (transaction) => {
                            const senderDoc = await transaction.get(senderRef);
                            if (!senderDoc.exists()) throw "Error: Sender not found";

                            const currentBalance = senderDoc.data().balance || 0;
                            if (currentBalance < totalDeduction) throw "Not enough money!";

                            const receiverDoc = await transaction.get(receiverRef);
                            if (!receiverDoc.exists()) throw "Error: Receiver not found";
                            
                            // 1. Списываем у отправителя
                            transaction.update(senderRef, { 
                                balance: increment(-totalDeduction),
                                transactions: arrayUnion({
                                    type: 'transfer_out',
                                    toUser: receiverData.username, 
                                    amount: amount,
                                    fee: amount * FEE_PERCENT,
                                    total: totalDeduction,
                                    date: new Date().toISOString()
                                })
                            });

                            // 2. Начисляем получателю
                            transaction.update(receiverRef, { 
                                balance: increment(amount),
                                transactions: arrayUnion({
                                    type: 'transfer_in',
                                    fromUser: currentUser.username || 'Hidden', 
                                    amount: amount, 
                                    date: new Date().toISOString()
                                })
                            });
                        });

                        tg.showAlert("Sent successfully!");
                        window.history.back();

                    } catch (e) {
                        console.error(e);
                        tg.showAlert("Transaction failed: " + e);
                    }
                }
            });
        }
    </script>
</body>
</html>
