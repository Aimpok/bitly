<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Transfer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* === LOADER STYLES === */
        #globalLoader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 99999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        #globalLoader.loaded { opacity: 0; visibility: hidden; pointer-events: none; }
        .custom-spinner {
            width: 40px; height: 40px; border-radius: 50%;
            border: 4px solid #333; border-top-color: #ffffff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- === ЗАГРУЗЧИК === -->
    <div id="globalLoader"><div class="custom-spinner"></div></div>

    <div class="header-nav">
        <button class="back-btn" onclick="window.history.back()">
            <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <div class="header-title">Transfer</div>
    </div>

    <div style="padding: 0 16px;">
        <!-- Amount Input -->
        <div class="input-wrapper">
            <!-- Ввод с авто-пробелами -->
            <input type="text" inputmode="decimal" id="amountInput" placeholder="Amount" oninput="handleInput(this)">
            <div class="input-suffix">
                <span>BLYX</span>
                <img src="Sprites/Blyx.png" class="star-icon-small" alt="blyx">
            </div>
        </div>
        
        <!-- Подсказка про комиссию и ЛИМИТЫ -->
        <div style="font-size: 12px; color: #666; margin-top: -8px; margin-bottom: 12px; margin-left: 10px;">
            Fee: 5% • Min: 10 • Max: 100k
        </div>

        <!-- Username Input with Avatar -->
        <div class="input-wrapper input-with-avatar" id="userWrapper">
            <img id="receiverAvatar" src="" class="avatar-preview">
            <input type="text" id="usernameInput" placeholder="@username" oninput="handleUsernameInput(this)" autocomplete="off">
            
            <div id="searchLoader" style="display:none; color: #888; font-size: 12px; margin-right: 10px;">
                ...
            </div>
        </div>
        
        <!-- Info Text -->
        <div id="receiverInfo" style="font-size: 12px; color: #FF3B30; margin-top: -8px; margin-bottom: 15px; margin-left: 10px; min-height: 14px;"></div>
    </div>

    <div class="bottom-cost-panel">
        <div class="cost-label">Total Cost (inc. 5% fee)</div>
        <button class="btn-white-large btn-disabled" id="sendBtn" onclick="doTransfer()">
            <span id="btnAmount">0</span>
            <img src="Sprites/Blyx.png" class="star-icon-small" alt="blyx">
        </button>
    </div>

    <script type="module">
        import { initUser, getUserRef } from './user-service.js';
        import { db } from './firebase-config.js';
        import { collection, query, where, getDocs, runTransaction, doc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');

        const loader = document.getElementById('globalLoader');

        let currentUser = null;
        let receiverData = null;
        let searchTimer = null;
        
        const FEE_PERCENT = 0.05; // 5%
        const MIN_TRANSFER = 10;
        const MAX_TRANSFER = 100000;

        // === ФОРМАТТЕР (визуально для текста) ===
        function formatDisplay(num) {
            if (num === undefined || num === null) return "0";
            let parts = num.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            if (parts[1]) return parts[0] + "." + parts[1].substring(0, 6);
            return parts[0];
        }

        // === ОБРАБОТЧИК ВВОДА (ставит пробелы) ===
        window.handleInput = function(el) {
            let raw = el.value.replace(/[^0-9.]/g, '');
            if ((raw.match(/\./g) || []).length > 1) raw = raw.replace(/\.$/, '');
            
            if(raw.endsWith('.')) {
                el.value = raw;
                updateButton();
                return;
            }
            if(!raw) {
                el.value = "";
                updateButton();
                return;
            }

            const parts = raw.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            if(parts[1] && parts[1].length > 6) parts[1] = parts[1].substring(0,6);

            el.value = parts.join('.');
            updateButton();
        }

        // === ПОЛУЧИТЬ ЧИСТОЕ ЧИСЛО (без пробелов) ===
        function getRawAmount() {
            const val = document.getElementById('amountInput').value;
            return parseFloat(val.replace(/\s/g, '')) || 0;
        }

        async function init() {
            try {
                currentUser = await initUser();
            } catch(e) { console.error(e); }
            if(loader) loader.classList.add('loaded');
        }
        init();

        window.updateButton = function() {
            const inputVal = getRawAmount(); // Чистое число
            const btn = document.getElementById('sendBtn');
            const infoBox = document.getElementById('receiverInfo');
            
            // Проверка лимитов
            if (inputVal && inputVal >= MIN_TRANSFER && inputVal <= MAX_TRANSFER) {
                const totalCost = inputVal * (1 + FEE_PERCENT); 
                // Кнопка показывает число с пробелами
                document.getElementById('btnAmount').innerText = formatDisplay(parseFloat(totalCost.toFixed(2)));
                
                if(receiverData) {
                    btn.classList.remove('btn-disabled');
                    if (infoBox.innerText.includes("Limit") || infoBox.innerText.includes("Minimum") || infoBox.innerText.includes("Maximum")) {
                        infoBox.innerText = "";
                    }
                } else {
                    btn.classList.add('btn-disabled');
                }
            } else {
                document.getElementById('btnAmount').innerText = "0";
                btn.classList.add('btn-disabled');
                
                if (inputVal && inputVal > 0) {
                    if (inputVal < MIN_TRANSFER) infoBox.innerText = `Minimum transfer is ${formatDisplay(MIN_TRANSFER)} BLYX`;
                    else if (inputVal > MAX_TRANSFER) infoBox.innerText = `Maximum transfer is ${formatDisplay(MAX_TRANSFER)} BLYX`;
                } else if (!receiverData) {
                    infoBox.innerText = "";
                }
            }
        }

        window.handleUsernameInput = function(el) {
            clearTimeout(searchTimer);
            const rawVal = el.value.trim();
            let usernameLower = rawVal.replace('@', '').toLowerCase(); 
            
            receiverData = null;
            document.getElementById('receiverAvatar').classList.remove('avatar-visible');
            document.getElementById('receiverInfo').innerText = ""; 
            updateButton(); 

            if(usernameLower.length < 3) return;

            document.getElementById('searchLoader').style.display = 'block';
            searchTimer = setTimeout(() => searchUser(usernameLower), 500);
        }

        async function searchUser(usernameLower) {
            try {
                const q = query(collection(db, "users"), where("username_lower", "==", usernameLower));
                const querySnapshot = await getDocs(q);

                document.getElementById('searchLoader').style.display = 'none';

                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const data = userDoc.data();

                    if(data.id.toString() === currentUser.id.toString()) {
                        document.getElementById('receiverInfo').innerText = "Cannot send to yourself";
                        return;
                    }

                    receiverData = { ...data, docId: userDoc.id };
                    const avatarEl = document.getElementById('receiverAvatar');
                    avatarEl.src = data.photoUrl && data.photoUrl.length > 5 ? data.photoUrl : 'Sprites/GiftIcon.png'; 
                    avatarEl.classList.add('avatar-visible');
                    document.getElementById('receiverInfo').innerText = ""; 
                    updateButton();
                } else {
                    document.getElementById('receiverInfo').innerText = "User not found";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('searchLoader').style.display = 'none';
                document.getElementById('receiverInfo').innerText = "Error searching user";
            }
        }

        window.doTransfer = async function() {
            const amount = getRawAmount();
            
            if(!amount) return;
            if(!receiverData) return;

            if (amount < MIN_TRANSFER) {
                tg.showAlert(`Minimum amount is ${formatDisplay(MIN_TRANSFER)} BLYX`);
                return;
            }
            if (amount > MAX_TRANSFER) {
                tg.showAlert(`Maximum amount is ${formatDisplay(MAX_TRANSFER)} BLYX`);
                return;
            }

            const totalDeduction = amount * (1 + FEE_PERCENT); 

            if(totalDeduction > currentUser.balance) { 
                tg.showAlert(`Insufficient funds! You need ${formatDisplay(totalDeduction.toFixed(2))} BLYX`); 
                return; 
            }

            // Красивый конфирм с пробелами
            tg.showConfirm(`Send ${formatDisplay(amount)} BLYX to @${receiverData.username}?\nTotal cost: ${formatDisplay(totalDeduction.toFixed(2))} BLYX`, async (ok) => {
                if(ok) {
                    if(loader) loader.classList.remove('loaded');
                    
                    try {
                        const senderRef = getUserRef();
                        const receiverRef = doc(db, "users", receiverData.docId);

                        await runTransaction(db, async (transaction) => {
                            const senderDoc = await transaction.get(senderRef);
                            if (!senderDoc.exists()) throw "Error: Sender not found";
                            const currentBalance = senderDoc.data().balance || 0;
                            if (currentBalance < totalDeduction) throw "Not enough money!";

                            const receiverDoc = await transaction.get(receiverRef);
                            if (!receiverDoc.exists()) throw "Error: Receiver not found";
                            
                            transaction.update(senderRef, { 
                                balance: increment(-totalDeduction),
                                transactions: arrayUnion({
                                    type: 'transfer_out',
                                    toUser: receiverData.username, 
                                    amount: amount,
                                    fee: amount * FEE_PERCENT,
                                    total: totalDeduction,
                                    date: new Date().toISOString()
                                })
                            });

                            transaction.update(receiverRef, { 
                                balance: increment(amount),
                                transactions: arrayUnion({
                                    type: 'transfer_in',
                                    fromUser: currentUser.username || 'Hidden', 
                                    amount: amount, 
                                    date: new Date().toISOString()
                                })
                            });
                        });

                        tg.showAlert("Sent successfully!");
                        window.history.back();

                    } catch (e) {
                        if(loader) loader.classList.add('loaded');
                        tg.showAlert("Transaction failed: " + e);
                    }
                }
            });
        }
    </script>
</body>
</html>
